<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Baroid Hub">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23CC0000'/%3E%3Cpath d='M50 20 C35 45 35 60 50 80 C65 60 65 45 50 20' fill='white'/%3E%3Ccircle cx='50' cy='65' r='8' fill='%23CC0000'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23CC0000'/%3E%3Cpath d='M50 20 C35 45 35 60 50 80 C65 60 65 45 50 20' fill='white'/%3E%3Ccircle cx='50' cy='65' r='8' fill='%23CC0000'/%3E%3C/svg%3E">
    <title>BAROID HUB | App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@400;600;800&display=swap"
        rel="stylesheet">
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --h-red: #CC0000;
            --h-black: #000000;
            --h-gray-light: #ECEFF0;
            --h-gray-med: #8E979D;
            --h-white: #FFFFFF;
            --h-bg: #F8F9FA;
            --h-card-bg: #FFFFFF;
            --h-text: #1a1a1a;
            --h-border: #E5E7EB;
            --h-sidebar: #FFFFFF;
        }

        .dark {
            --h-bg: #0b0f1a;
            --h-text: #f1f5f9;
            --h-card-bg: #151c2c;
            --h-sidebar: #151c2c;
            --h-border: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--h-bg);
            color: var(--h-text);
            margin: 0;
            overflow-x: hidden;
        }

        .title-font {
            font-family: 'Outfit', sans-serif;
        }

        .sidebar-bg {
            background-color: var(--h-sidebar);
            border-right: 1px solid var(--h-border);
        }

        .sidebar-item-active {
            background-color: #CC0000;
            color: white !important;
        }

        .card-shadow {
            background-color: var(--h-card-bg);
            border: 1px solid var(--h-border);
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .card-shadow {
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .card-shadow:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px -12px rgba(204, 0, 0, 0.2);
            border-color: var(--h-red);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--h-gray-med);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes heartPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-heart-pop {
            animation: heartPop 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-entrance {
            animation: cardSlideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
        }

        @keyframes cardSlideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .hover-glow:hover {
            box-shadow: 0 0 25px -5px rgba(204, 0, 0, 0.2);
            border-color: rgba(204, 0, 0, 0.4);
        }

        .dark .hover-glow:hover {
            box-shadow: 0 0 35px -10px rgba(204, 0, 0, 0.4);
            border-color: rgba(204, 0, 0, 0.6);
        }

        .favorite-active {
            color: #CC0000 !important;
            fill: #CC0000 !important;
            filter: drop-shadow(0 0 12px rgba(204, 0, 0, 0.4));
            transform: scale(1.15);
        }

        .dark .favorite-active {
            filter: drop-shadow(0 0 15px rgba(204, 0, 0, 0.6));
        }

        @keyframes modalShow {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-modal-in {
            animation: modalShow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .btn-primary {
            background-color: var(--h-red);
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #a30000;
            transform: scale(1.02);
        }

        /* Thicker border and subtle bg for inputs */
        .input-style {
            background-color: var(--h-card-bg);
            border: 2px solid var(--h-border);
            color: var(--h-text);
            border-radius: 14px;
            padding: 12px 18px;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .dark .input-style {
            background-color: rgba(21, 28, 44, 0.6);
            border-color: #2d3748;
        }

        .input-style:focus {
            border-color: var(--h-red);
            background-color: var(--h-card-bg);
            outline: none;
            box-shadow: 0 0 0 4px rgba(204, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }

        .notepad-area {
            background-image:
                linear-gradient(var(--h-border) 1px, transparent 1px);
            background-size: 100% 1.5rem;
            line-height: 1.5rem;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark .glass-morphism {
            background: rgba(21, 28, 44, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .notes-bubble {
            box-shadow: 0 8px 32px rgba(204, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notes-bubble:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 40px rgba(204, 0, 0, 0.4);
        }

        .notes-window {
            transform-origin: bottom right;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notes-window.hidden {
            transform: scale(0.8) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }

        .notes-window.visible {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        halliburton: {
                            red: '#CC0000',
                            dark: '#1a1a1a',
                            gray: '#8E979D',
                            light: '#ECEFF0'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "", style = {} }) => {
            const iconRef = useRef(null);

            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    try {
                        // Limpiar contenido previo para evitar duplicados o errores de Lucide
                        iconRef.current.innerHTML = '';
                        const i = document.createElement('i');
                        i.setAttribute('data-lucide', name);
                        i.style.width = `${size}px`;
                        i.style.height = `${size}px`;
                        iconRef.current.appendChild(i);

                        window.lucide.createIcons({
                            elements: [i]
                        });
                    } catch (e) {
                        console.error("Icon render error:", e);
                    }
                }
            }, [name, size]); // Añadido size por si cambia

            return <span
                ref={iconRef}
                className={`inline-flex items-center justify-center ${className}`}
                style={{ width: size, height: size, ...style }}
            ></span>;
        };

        const getDisplayUrl = (url) => {
            try {
                if (url.startsWith('http')) {
                    return new URL(url).hostname.replace('www.', '');
                }
                return url.split('/').pop().split('\\').pop();
            } catch (e) {
                return url;
            }
        };

        const GreetingDashboard = () => {
            const [time, setTime] = useState(new Date());
            const [activeIndex, setActiveIndex] = useState(0);

            const messages = [
                {
                    title: "Mainstays de BAROID",
                    content: "Business Acquisition Process • Technical Process • Black Book • System Rationalization • People",
                    icon: "target"
                },
                {
                    title: "Propuesta de Valor",
                    content: "Soluciones de fluidos personalizadas para maximizar el valor del pozo y activos del cliente.",
                    icon: "trending-up"
                },
                {
                    title: "Control Points (BSD)",
                    content: "DoS Aprobado • Plan de Demanda Verificado • Ejecución Confirmada • Reporte Completado",
                    icon: "shield-check"
                }
            ];

            const reminders = [
                { text: "Recorda hacer tus Observaciones en One View", icon: "eye" },
                { text: "Pedido de Laboratorio antes del Domingo", icon: "beaker" },
                { text: "Verificar stock de químicos críticos", icon: "clipboard-list" }
            ];

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                const syncTimer = setInterval(() => {
                    setActiveIndex((prev) => (prev + 1) % messages.length);
                }, 12000);
                return () => {
                    clearInterval(timer);
                    clearInterval(syncTimer);
                };
            }, []);

            const hours = time.getHours();
            const greeting = hours < 12 ? 'Buenos Días' : hours < 20 ? 'Buenas Tardes' : 'Buenas Noches';

            return (
                <div className="mb-14 p-10 pb-16 bg-gradient-to-br from-halliburton-red to-[#a30000] rounded-[3rem] text-white shadow-2xl relative overflow-hidden group animate-fade-in transition-all">
                    {/* Background Icon Decoration */}
                    <div className="absolute top-0 right-0 p-12 opacity-10 group-hover:scale-110 transition-transform duration-700">
                        <Icon name="clock" size={120} />
                    </div>

                    {/* Bottom Ticker/Reminder Section */}
                    <div className="absolute bottom-0 left-0 right-0 h-10 bg-black/10 flex items-center px-10 border-t border-white/5">
                        <div className="flex items-center gap-2 animate-fade-in" key={activeIndex}>
                            <Icon name={reminders[activeIndex].icon} size={12} className="text-white/40" />
                            <span className="text-[9px] font-black uppercase tracking-[0.2em] text-white/30">Recordatorio:</span>
                            <span className="text-[9px] font-bold uppercase tracking-widest text-white/70">{reminders[activeIndex].text}</span>
                        </div>
                    </div>

                    <div className="relative z-10">
                        <p className="text-[12px] font-black uppercase tracking-[0.3em] mb-4 opacity-80">Dashboard Operativo</p>
                        <h2 className="text-5xl font-black uppercase italic leading-none mb-10">{greeting}</h2>

                        <div className="flex flex-col md:flex-row md:items-center gap-8">
                            <div className="flex items-center gap-6">
                                <div className="flex flex-col">
                                    <span className="text-3xl font-black tabular-nums leading-none mb-1">{time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                    <span className="text-[10px] font-bold uppercase tracking-widest opacity-60">{time.toLocaleDateString([], { weekday: 'long', day: 'numeric', month: 'long' })}</span>
                                </div>
                            </div>

                            <div className="hidden md:block h-12 w-[1px] bg-white/20"></div>

                            <div className="flex items-center gap-4 animate-fade-in" key={activeIndex}>
                                <div className="p-3 bg-white/10 rounded-2xl backdrop-blur-md">
                                    <Icon name={messages[activeIndex].icon} size={24} />
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-300 mb-1">{messages[activeIndex].title}</span>
                                    <p className="text-[13px] font-bold leading-tight max-w-[450px] uppercase italic text-white/90">
                                        {messages[activeIndex].content}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const FluidCalculator = ({ isEditing }) => {
            const [activeSubTab, setActiveSubTab] = useState('conv'); // 'eng', 'conv', 'barite', 'mixing'
            const [unitMode, setUnitMode] = useState('field');

            // Engineering State
            const [eng, setEng] = useState({ dens: '', depth: '', diam: '' });

            // Barite State
            const [barite, setBarite] = useState({ vol: '', d1: '', d2: '', sg: '4.2' });

            // Mixing State
            const [mix, setMix] = useState([
                { vol: '', dens: '' },
                { vol: '', dens: '' },
                { vol: '', dens: '' }
            ]);

            // Slug State
            const [slug, setSlug] = useState({ lengthSeca: '', idDP: '', densMud: '', densSlug: '', safetyPressure: '200', valveResist: '', mpdSBP: '', volToPrepare: '' });
            const [showAdvancedSlug, setShowAdvancedSlug] = useState(false);

            // OWR State
            const [owr, setOwr] = useState({ vOil: '', vWater: '', targetRatio: '80' });

            // FIT State
            const [fit, setFit] = useState({ targetEMW: '', currentMW: '', shoeTVD: '' });

            // Pf/Mf State
            const [titration, setTitration] = useState({ pf: '', mf: '', ca: '', pom: '' });

            // Treatment Visibility State (No reordering here as per user request)
            const [treatmentConfig, setTreatmentConfig] = useState(() => {
                const saved = localStorage.getItem('baroid_treatment_config');
                return saved ? JSON.parse(saved) : [
                    { id: 'lime', label: 'Cal (Limpiar Carb.)', visible: true },
                    { id: 'sodaAsh', label: 'Soda Ash (Rem. Ca++)', visible: true },
                    { id: 'sodiumBicarb', label: 'Bicarb. (Rem. Ca++)', visible: true }
                ];
            });

            // Tabs Configuration State (Order and Visibility)
            const [tabsConfig, setTabsConfig] = useState(() => {
                const saved = localStorage.getItem('baroid_calc_tabs_v3');
                return saved ? JSON.parse(saved) : [
                    { id: 'conv', label: 'Conversor de Unidades', icon: 'repeat', visible: true },
                    { id: 'barite', label: 'Ajuste de Densidad', icon: 'arrow-up-circle', visible: true },
                    { id: 'mixing', label: 'Mezcla (Balance Masa)', icon: 'blend', visible: true },
                    { id: 'eng', label: 'Hidrostática & Capacidad', icon: 'droplet', visible: true },
                    { id: 'owr', label: 'Relación Aceite/Agua', icon: 'droplet-off', visible: true },
                    { id: 'slug', label: 'Píldoras (Slugs)', icon: 'flask-conical', visible: true },
                    { id: 'fit', label: 'Integridad (FIT)', icon: 'shield-check', visible: true },
                    { id: 'pfmf', label: 'Pf/Mf & Tratamiento', icon: 'beaker', visible: true }
                ];
            });

            useEffect(() => {
                localStorage.setItem('baroid_treatment_config', JSON.stringify(treatmentConfig));
            }, [treatmentConfig]);

            useEffect(() => {
                localStorage.setItem('baroid_calc_tabs_v3', JSON.stringify(tabsConfig));
            }, [tabsConfig]);

            // Special Hybrid Units for Mixing and Barite (Independent of unitMode)
            const [mixUnits, setMixUnits] = useState({
                vol: unitMode === 'metric' ? 'm3' : 'bbl',
                dens: unitMode === 'metric' ? 'gL' : 'ppg'
            });

            const [bariteUnits, setBariteUnits] = useState({
                vol: unitMode === 'metric' ? 'm3' : 'bbl',
                dens: unitMode === 'metric' ? 'gL' : 'ppg'
            });

            useEffect(() => {
                const volUnit = unitMode === 'metric' ? 'm3' : 'bbl';
                const densUnit = unitMode === 'metric' ? 'gL' : 'ppg';
                setMixUnits({ vol: volUnit, dens: densUnit });
                setBariteUnits({ vol: volUnit, dens: densUnit });
            }, [unitMode]);

            // Conversion State
            const [convVal, setConvVal] = useState('');
            const [convReverse, setConvReverse] = useState(false);

            // Helpers
            const ppgToGL = (val) => val * 119.826;
            const glToPPG = (val) => val / 119.826;
            const mToFt = (val) => val * 3.28084;
            const ftToM = (val) => val / 3.28084;
            const bblToM3 = (val) => val * 0.158987;
            const m3ToBbl = (val) => val / 0.158987;
            const psiToKgCm2 = (val) => val * 0.070307;

            const getHydrostatic = () => {
                if (!eng.dens || !eng.depth) return 0;
                const dppg = unitMode === 'field' ? parseFloat(eng.dens) : glToPPG(parseFloat(eng.dens));
                const dft = mToFt(parseFloat(eng.depth));
                return (0.052 * dppg * dft).toFixed(2);
            };

            const getBariteTons = () => {
                const { vol, d1, d2 } = barite;
                if (!vol || !d1 || !d2) return 0;

                let v_m3 = bariteUnits.vol === 'm3' ? parseFloat(vol) : bblToM3(parseFloat(vol));
                let sg1 = bariteUnits.dens === 'gL' ? parseFloat(d1) / 1000 : parseFloat(d1) / 8.33;
                let sg2 = bariteUnits.dens === 'gL' ? parseFloat(d2) / 1000 : parseFloat(d2) / 8.33;

                if (sg2 <= sg1) return 0;
                // Formula: Mass Barite = V_initial * (SG2 - SG1) / (SG_barite - SG2) * SG_barite
                const sgB = parseFloat(barite.sg) || 4.2;
                if (sg2 >= sgB) return 0;

                const tons = v_m3 * (sg2 - sg1) / (sgB - sg2) * sgB;
                return tons.toFixed(2);
            };

            const getSlugResult = () => {
                const { lengthSeca, idDP, densMud, densSlug, safetyPressure, valveResist, mpdSBP, volToPrepare } = slug;

                // 0. Calculate capacity first (must work even if other fields are empty)
                let c = 0;
                let c_val = 0;
                let cField_local = 0;
                if (idDP && !isNaN(parseFloat(idDP))) {
                    const id = parseFloat(idDP);
                    cField_local = (id ** 2) / 1029.4;
                    const cMetric = cField_local * 0.52161;
                    c_val = unitMode === 'field' ? cField_local : cMetric;
                    c = c_val.toFixed(5);
                }

                if (!lengthSeca || !idDP || !densMud || !densSlug) {
                    return { volReq: 0, volFinal: 0, tons: 0, volInitial: 0, currentCap: c };
                }

                const dm = parseFloat(densMud);
                const ds = parseFloat(densSlug);
                const l = parseFloat(lengthSeca);

                // Additional Pressures to overcome (all in PSI for internal calc)
                const pSafe = parseFloat(safetyPressure || 0);
                const pValve = parseFloat(valveResist || 0);
                const pMPD = parseFloat(mpdSBP || 0);
                const totalExtraPressure = (isNaN(pSafe) ? 0 : pSafe) + (isNaN(pValve) ? 0 : pValve) + (isNaN(pMPD) ? 0 : pMPD);

                if (ds <= dm) return { volReq: 0, volFinal: 0, tons: 0, volInitial: 0, currentCap: c };

                // 1. Calculate Minimum Required Volume
                const dm_ppg = unitMode === 'field' ? dm : glToPPG(dm);
                const ds_ppg = unitMode === 'field' ? ds : glToPPG(ds);

                // Convert depth to ft for internal calculation if needed
                const l_ft = unitMode === 'field' ? l : mToFt(l);

                // Formula: H_slug = (L_dry * MW_mud * 0.052 + P_extra) / (0.052 * (MW_slug - MW_mud))
                const hSlug_ft = (l_ft * dm_ppg * 0.052 + totalExtraPressure) / (0.052 * (ds_ppg - dm_ppg));
                const vSlugReq_bbl = hSlug_ft * cField_local; // cField_local is always bbl/ft

                const vSlugReq = unitMode === 'field' ? vSlugReq_bbl : bblToM3(vSlugReq_bbl);

                // 2. Use Custom Volume if provided, otherwise Req Volume
                const vFinal = parseFloat(volToPrepare) || vSlugReq;

                // 3. Formulation for vFinal
                const sg_slug = ds_ppg / 8.33;
                const sg_mud = dm_ppg / 8.33;
                const sg_barite = 4.2;

                const volInitial = vFinal * (sg_barite - sg_slug) / (sg_barite - sg_mud);

                // Barite calculation per barrel
                const lbsPerBbl = (1470 * (ds_ppg - dm_ppg)) / (35.0 - ds_ppg);
                const vol_bbl_initial = unitMode === 'field' ? volInitial : m3ToBbl(volInitial);
                const totalLbs = lbsPerBbl * vol_bbl_initial;
                const totalTons = totalLbs / 2204.62;

                return {
                    volReq: isNaN(vSlugReq) ? 0 : vSlugReq.toFixed(2),
                    volFinal: isNaN(vFinal) ? 0 : vFinal.toFixed(2),
                    tons: isNaN(totalTons) ? 0 : totalTons.toFixed(2),
                    volInitial: isNaN(volInitial) ? 0 : volInitial.toFixed(2),
                    currentCap: c
                };
            };

            const getOWRResult = () => {
                const { vOil, vWater, targetRatio } = owr;
                if (!vOil || !vWater) return { current: '0/0', addOil: 0, addWater: 0 };

                const vo = parseFloat(vOil);
                const vw = parseFloat(vWater);
                const total = vo + vw;
                if (total === 0) return { current: '0/0', addOil: 0, addWater: 0 };

                const currentRatioOil = (vo / total) * 100;
                const currentRatioWater = (vw / total) * 100;

                const target = parseFloat(targetRatio);
                const targetPerm = 100 - target;

                // Adjustments per bbl
                // R_W = % water decimal
                const rw = vw / total;
                const ro = vo / total;
                const pw = targetPerm / 100;
                const po = target / 100;

                const addOil = Math.max(0, (rw / pw) - rw - ro);
                const addWater = Math.max(0, (ro / po) - rw - ro);

                return {
                    current: `${currentRatioOil.toFixed(1)}/${currentRatioWater.toFixed(1)}`,
                    addOil: addOil.toFixed(3),
                    addWater: addWater.toFixed(3),
                    oilPct: currentRatioOil,
                    waterPct: currentRatioWater
                };
            };

            const getPfMfResult = () => {
                const pf = parseFloat(titration.pf) || 0;
                const mf = parseFloat(titration.mf) || 0;
                const ca = parseFloat(titration.ca) || 0;

                let oh = 0, co3 = 0, hco3 = 0;

                if (pf === 0) {
                    hco3 = 1220 * mf;
                } else if (2 * pf < mf) {
                    co3 = 1200 * pf;
                    hco3 = 1220 * (mf - 2 * pf);
                } else if (2 * pf === mf) {
                    co3 = 1200 * pf;
                } else if (2 * pf > mf && pf < mf) {
                    oh = 340 * (2 * pf - mf);
                    co3 = 1200 * (mf - pf);
                } else if (pf === mf) {
                    oh = 340 * mf;
                }

                const factor = unitMode === 'field' ? 1 : 2.853;

                return {
                    oh: oh.toFixed(0),
                    co3: co3.toFixed(0),
                    hco3: hco3.toFixed(0),
                    lime: (0.00043 * (co3 + hco3) * factor).toFixed(3),
                    sodaAsh: (0.000925 * ca * factor).toFixed(3),
                    sodiumBicarb: (0.000734 * ca * factor).toFixed(3)
                };
            };

            const getFITResult = () => {
                const { targetEMW: temw, currentMW: cmw, shoeTVD: tvd } = fit;
                if (!temw || !cmw || !tvd) return { surface: 0, total: 0, hydrostatic: 0, surfacePSI: 0 };

                const target = parseFloat(temw);
                const current = parseFloat(cmw);
                const depth = parseFloat(tvd);

                if (target <= current) return { surface: 0, total: 0, hydrostatic: 0, surfacePSI: 0 };

                let surface = 0;
                let hydro = 0;
                let surfacePSI = 0;

                if (unitMode === 'field') {
                    // Field: Pressure (psi) = (EMW - MW) * 0.052 * TVD
                    surface = (target - current) * 0.052 * depth;
                    hydro = current * 0.052 * depth;
                    surfacePSI = surface;
                } else {
                    // Metric: Pressure (kg/cm2) = (EMW[g/L] - MW[g/L]) * TVD[m] * 0.0001
                    surface = (target - current) * depth * 0.0001;
                    hydro = current * depth * 0.0001;
                    surfacePSI = surface / 0.070307; // Convert kg/cm2 to PSI
                }

                return {
                    surface: surface.toFixed(1),
                    hydrostatic: hydro.toFixed(1),
                    total: (surface + hydro).toFixed(1),
                    surfacePSI: surfacePSI.toFixed(1)
                };
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert("¡Resultado copiado al portapapeles!");
                });
            };

            const getMixingResult = () => {
                let totalVol = 0;
                let totalMass = 0;
                mix.forEach(f => {
                    if (f.vol && f.dens) {
                        const v = parseFloat(f.vol);
                        const d = parseFloat(f.dens);
                        totalVol += v;
                        totalMass += v * d;
                    }
                });
                if (totalVol === 0) return { dens: 0, vol: 0 };
                return { dens: (totalMass / totalVol).toFixed(2), vol: totalVol.toFixed(2) };
            };

            const toggleTreatment = (id) => {
                setTreatmentConfig(prev => prev.map(t => t.id === id ? { ...t, visible: !t.visible } : t));
            };

            const toggleTab = (id) => {
                setTabsConfig(prev => prev.map(t => t.id === id ? { ...t, visible: !t.visible } : t));
            };

            const moveTab = (index, direction) => {
                const newOrder = [...tabsConfig];
                const targetIndex = index + direction;
                if (targetIndex >= 0 && targetIndex < newOrder.length) {
                    [newOrder[index], newOrder[targetIndex]] = [newOrder[targetIndex], newOrder[index]];
                    setTabsConfig(newOrder);
                }
            };

            const addMixingFluid = () => {
                setMix([...mix, { vol: '', dens: '' }]);
            };

            return (
                <div className="animate-fade-in space-y-8">
                    {/* Header Calculator */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div className="flex items-center gap-4">
                            <div className="p-4 bg-halliburton-red rounded-3xl shadow-lg shadow-red-900/20">
                                <Icon name="calculator" size={32} className="text-white" />
                            </div>
                            <div>
                                <h3 className="text-3xl font-black uppercase italic tracking-tighter text-zinc-800 dark:text-white">Ingeniería de Fluidos</h3>
                                <p className="text-[10px] font-black text-zinc-400 uppercase tracking-widest">Soluciones de Fluidos</p>
                            </div>
                        </div>
                        <div className="flex bg-zinc-100 dark:bg-slate-800 p-1.5 rounded-2xl border border-zinc-200 dark:border-zinc-700 self-start">
                            <button onClick={() => setUnitMode('field')} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${unitMode === 'field' ? 'bg-halliburton-red text-white shadow-md' : 'text-zinc-500'}`}>Campo</button>
                            <button onClick={() => setUnitMode('metric')} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${unitMode === 'metric' ? 'bg-halliburton-red text-white shadow-md' : 'text-zinc-500'}`}>Métrico</button>
                        </div>
                    </div>

                    {/* SubTabs Navigation */}
                    <div className="relative group/nav">
                        <div id="subtabs-container" className="flex gap-2 overflow-x-auto pb-6 custom-scrollbar no-scrollbar-at-rest scroll-smooth">
                            {tabsConfig.map((tab, idx) => (
                                <div key={tab.id} className={`relative flex items-center group/tab-item ${(tab.visible || isEditing) ? 'block' : 'hidden'}`}>
                                    {isEditing && (
                                        <div className="absolute -top-3 left-1/2 -translate-x-1/2 flex gap-1 z-20 opacity-0 group-hover/tab-item:opacity-100 transition-opacity">
                                            <button onClick={(e) => { e.stopPropagation(); toggleTab(tab.id); }} className={`p-1 rounded-full ${tab.visible ? 'bg-green-500' : 'bg-zinc-600'} text-white shadow-lg`}><Icon name={tab.visible ? "eye" : "eye-off"} size={8} /></button>
                                            <button onClick={(e) => { e.stopPropagation(); moveTab(idx, -1); }} className="p-1 bg-zinc-700 rounded-full text-white shadow-lg"><Icon name="chevron-left" size={8} /></button>
                                            <button onClick={(e) => { e.stopPropagation(); moveTab(idx, 1); }} className="p-1 bg-zinc-700 rounded-full text-white shadow-lg"><Icon name="chevron-right" size={8} /></button>
                                        </div>
                                    )}
                                    <button
                                        onClick={() => setActiveSubTab(tab.id)}
                                        className={`flex items-center gap-2 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all border ${!tab.visible ? 'opacity-40 border-dashed bg-transparent' : ''} ${activeSubTab === tab.id ? 'bg-zinc-900 text-white border-zinc-900 shadow-md ring-2 ring-halliburton-red/10' : 'bg-white dark:bg-slate-800 text-zinc-500 border-zinc-100 dark:border-zinc-700 hover:border-halliburton-red'}`}
                                    >
                                        <Icon name={tab.icon} size={14} />
                                        {tab.label}
                                    </button>
                                </div>
                            ))}
                        </div>
                        <button
                            onClick={() => {
                                const container = document.getElementById('subtabs-container');
                                if (container) container.scrollBy({ left: 200, behavior: 'smooth' });
                            }}
                            className="absolute right-0 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/90 dark:bg-slate-800/90 shadow-xl rounded-full flex items-center justify-center opacity-0 group-hover/nav:opacity-100 transition-opacity border border-zinc-200 dark:border-zinc-700 z-30"
                        >
                            <Icon name="chevron-right" size={20} className="text-halliburton-red" />
                        </button>
                    </div>

                    {/* Content Sections */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* Inputs Side */}
                        <div className={`${activeSubTab === 'conv' ? 'lg:col-span-7' : 'lg:col-span-5'} bg-white dark:bg-slate-800/40 p-10 rounded-[3.5rem] card-shadow border border-zinc-50 dark:border-zinc-800/50`}>
                            {activeSubTab === 'eng' && (
                                <div className="space-y-6">
                                    <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest mb-4 italic">Parámetros Pozo</h4>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Densidad ({unitMode === 'field' ? 'ppg' : 'g/L'})</label>
                                        <input type="number" value={eng.dens} onChange={e => setEng({ ...eng, dens: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Profundidad (metros)</label>
                                        <input type="number" value={eng.depth} onChange={e => setEng({ ...eng, depth: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Diámetro (pulgadas)</label>
                                        <input type="number" value={eng.diam} onChange={e => setEng({ ...eng, diam: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'conv' && (
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="text-[11px] font-black text-halliburton-red uppercase tracking-widest italic">Valor a Convertir</h4>
                                        <button
                                            onClick={() => setConvReverse(!convReverse)}
                                            className="group flex items-center gap-2 px-4 py-2 bg-zinc-100 dark:bg-slate-900 text-zinc-600 dark:text-zinc-400 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-halliburton-red hover:text-white transition-all shadow-sm border border-zinc-200 dark:border-zinc-800"
                                        >
                                            <Icon name="repeat" size={12} className="group-hover:rotate-180 transition-transform duration-500" />
                                            {convReverse ? 'Sentido Inverso' : 'Sentido Directo'}
                                        </button>
                                    </div>
                                    <div className="relative group">
                                        <input type="number" value={convVal} onChange={e => setConvVal(e.target.value)} className="w-full input-style text-3xl font-black mb-10 pr-40" placeholder="0.00" />
                                        <div className="absolute right-6 top-5 px-3 py-1 bg-zinc-100 dark:bg-slate-900 rounded-lg text-zinc-400 font-black text-[10px] uppercase tracking-widest border border-zinc-200 dark:border-zinc-800 shadow-sm">{convReverse ? 'Hacia Campo' : 'Desde Campo'}</div>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {[
                                            {
                                                label: 'Densidad',
                                                v1: `${(convVal * 1).toFixed(2)} ${convReverse ? 'g/L' : 'ppg'}`,
                                                v2: `${convReverse ? glToPPG(convVal || 0).toFixed(2) + ' ppg' : ppgToGL(convVal || 0).toFixed(1) + ' g/L'}`
                                            },
                                            {
                                                label: 'Volumen',
                                                v1: `${(convVal * 1).toFixed(1)} ${convReverse ? 'm³' : 'bbl'}`,
                                                v2: `${convReverse ? m3ToBbl(convVal || 0).toFixed(2) + ' bbl' : bblToM3(convVal || 0).toFixed(2) + ' m³'}`
                                            },
                                            {
                                                label: 'Longitud',
                                                v1: `${(convVal * 1).toFixed(1)} ${convReverse ? 'ft' : 'm'}`,
                                                v2: `${convReverse ? ftToM(convVal || 0).toFixed(2) + ' m' : mToFt(convVal || 0).toFixed(1) + ' ft'}`
                                            },
                                            {
                                                label: 'Presión',
                                                v1: `${(convVal * 1).toFixed(1)} ${convReverse ? 'kg/cm²' : 'psi'}`,
                                                v2: `${convReverse ? (convVal / 0.070307).toFixed(1) + ' psi' : psiToKgCm2(convVal || 0).toFixed(2) + ' kg/cm²'}`
                                            },
                                            {
                                                label: 'Caudal',
                                                v1: `${(convVal * 1).toFixed(1)} ${convReverse ? 'bpm' : 'gpm'}`,
                                                v2: `${convReverse ? (convVal * 42).toFixed(1) + ' gpm' : (convVal / 42).toFixed(2) + ' bpm'}`
                                            },
                                            {
                                                label: 'ROP',
                                                v1: `${(convVal * 1).toFixed(1)} ${convReverse ? 'ft/min' : 'm/h'}`,
                                                v2: `${convReverse ? (convVal * 60 / 3.28084).toFixed(1) + ' m/h' : (convVal * 3.28084 / 60).toFixed(2) + ' ft/min'}`
                                            }
                                        ].map(c => (
                                            <div key={c.label} className="p-5 bg-zinc-50 dark:bg-slate-900/60 rounded-3xl flex justify-between items-center border border-zinc-100 dark:border-zinc-800/50">
                                                <span className="text-[13px] font-black text-zinc-600 dark:text-zinc-400 uppercase tracking-widest">{c.label}</span>
                                                <div className="flex items-center gap-3">
                                                    <span className="font-bold text-zinc-400 text-sm italic">{c.v1}</span>
                                                    <Icon name="arrow-right" size={12} className="text-halliburton-red opacity-30" />
                                                    <span className="font-black text-zinc-900 dark:text-zinc-200">{c.v2}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'barite' && (
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest italic">Ajuste de Densidad</h4>
                                        <div className="flex gap-2 bg-zinc-100 dark:bg-slate-900 p-1.5 rounded-2xl">
                                            <button onClick={() => setBariteUnits({ ...bariteUnits, vol: bariteUnits.vol === 'm3' ? 'bbl' : 'm3' })} className="px-6 py-2.5 rounded-xl bg-zinc-800 text-white text-[11px] font-black uppercase shadow-lg hover:scale-105 transition-transform active:scale-95">{bariteUnits.vol}</button>
                                            <button onClick={() => setBariteUnits({ ...bariteUnits, dens: bariteUnits.dens === 'ppg' ? 'gL' : 'ppg' })} className="px-6 py-2.5 rounded-xl bg-zinc-800 text-white text-[11px] font-black uppercase shadow-lg hover:scale-105 transition-transform active:scale-95">{bariteUnits.dens}</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Volumen Inicial ({bariteUnits.vol})</label>
                                        <input type="number" value={barite.vol} onChange={e => setBarite({ ...barite, vol: e.target.value })} className="w-full input-style text-xl font-bold" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">D. Actual ({bariteUnits.dens})</label>
                                            <input type="number" value={barite.d1} onChange={e => setBarite({ ...barite, d1: e.target.value })} className="w-full input-style" />
                                        </div>
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">D. Final ({bariteUnits.dens})</label>
                                            <input type="number" value={barite.d2} onChange={e => setBarite({ ...barite, d2: e.target.value })} className="w-full input-style" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-halliburton-red uppercase tracking-widest mb-2 block">SG Material</label>
                                        <input type="number" value={barite.sg} onChange={e => setBarite({ ...barite, sg: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="4.2" step="0.01" />
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'slug' && (
                                <div className="space-y-6">
                                    <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest mb-4 italic">Diseño de Píldora Pesada</h4>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Longitud Seca Deseada ({unitMode === 'field' ? 'ft' : 'm'})</label>
                                        <input type="number" value={slug.lengthSeca} onChange={e => setSlug({ ...slug, lengthSeca: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">ID Drill Pipe (in)</label>
                                            <input type="number" value={slug.idDP} onChange={e => setSlug({ ...slug, idDP: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                        </div>
                                        <div>
                                            <label className="text-[13px] font-black text-halliburton-red uppercase tracking-widest mb-2 block">Capacidad Calc.</label>
                                            <div className="w-full bg-zinc-100 dark:bg-slate-900 rounded-xl p-3 text-sm font-black text-zinc-400 border border-zinc-200 dark:border-zinc-800 flex items-center h-[52px]">
                                                {getSlugResult().currentCap || '0.000'} <small className="ml-1 opacity-50">{unitMode === 'field' ? 'bbl/ft' : 'm³/m'}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Dens. Fluido ({unitMode === 'field' ? 'ppg' : 'g/L'})</label>
                                            <input type="number" value={slug.densMud} onChange={e => setSlug({ ...slug, densMud: e.target.value })} className="w-full input-style" />
                                        </div>
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Dens. Píldora ({unitMode === 'field' ? 'ppg' : 'g/L'})</label>
                                            <input type="number" value={slug.densSlug} onChange={e => setSlug({ ...slug, densSlug: e.target.value })} className="w-full input-style" />
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t border-zinc-100 dark:border-zinc-800">
                                        <button
                                            onClick={() => setShowAdvancedSlug(!showAdvancedSlug)}
                                            className="w-full flex justify-between items-center mb-2 group py-2"
                                            type="button"
                                        >
                                            <h5 className="text-[10px] font-black text-zinc-400 group-hover:text-halliburton-red uppercase tracking-[0.2em] transition-colors">Factores de Resistencia (Opcional)</h5>
                                            <div className={`p-1 rounded-lg transition-all ${showAdvancedSlug ? 'bg-halliburton-red text-white rotate-180' : 'bg-zinc-100 dark:bg-slate-800 text-zinc-400'}`}>
                                                <Icon name="chevron-down" size={12} />
                                            </div>
                                        </button>

                                        {showAdvancedSlug && (
                                            <div className="space-y-4 animate-in fade-in slide-in-from-top-2 duration-200">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-[12px] font-black text-zinc-500 dark:text-zinc-400 uppercase mb-2 block">Válvulas/Motor (PSI)</label>
                                                        <input type="number" value={slug.valveResist} onChange={e => setSlug({ ...slug, valveResist: e.target.value })} className="w-full input-style" placeholder="Resorte/Fricción" title="Presión necesaria para abrir la válvula flotadora (Float Valve) o vencer motores." />
                                                    </div>
                                                    <div>
                                                        <label className="text-[12px] font-black text-zinc-500 dark:text-zinc-400 uppercase mb-2 block">MPD SBP (PSI)</label>
                                                        <input type="number" value={slug.mpdSBP} onChange={e => setSlug({ ...slug, mpdSBP: e.target.value })} className="w-full input-style" placeholder="Contrapresión" title="Surface Back Pressure aplicada por unidad de MPD en el anular." />
                                                    </div>
                                                </div>
                                                <div className="bg-zinc-100/50 dark:bg-slate-900/40 p-4 rounded-2xl border border-zinc-100 dark:border-zinc-800 space-y-3">
                                                    <div className="flex gap-3">
                                                        <Icon name="info" size={14} className="text-halliburton-red shrink-0 mt-0.5" />
                                                        <p className="text-[10px] font-bold text-zinc-500 uppercase leading-normal">
                                                            <span className="text-zinc-700 dark:text-zinc-300">Válvulas/Motor:</span> Presión extra necesaria para vencer el resorte del Float Valve o la resistencia interna de motores/MWD.
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <Icon name="activity" size={14} className="text-blue-500 shrink-0 mt-0.5" />
                                                        <p className="text-[10px] font-bold text-zinc-500 uppercase leading-normal">
                                                            <span className="text-zinc-700 dark:text-zinc-300">MPD SBP:</span> Contrapresión de superficie aplicada en el anular.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 border-t border-zinc-100 dark:border-zinc-800 pt-4">
                                        <div>
                                            <label className="text-[13px] font-black text-halliburton-red uppercase tracking-widest mb-2 block">Margen Seguridad (PSI)</label>
                                            <input type="number" value={slug.safetyPressure} onChange={e => setSlug({ ...slug, safetyPressure: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="200" />
                                        </div>
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Vol. a Preparar ({unitMode === 'field' ? 'bbl' : 'm³'})</label>
                                            <input type="number" value={slug.volToPrepare} onChange={e => setSlug({ ...slug, volToPrepare: e.target.value })} className="w-full input-style" placeholder="Opcional" />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'owr' && (
                                <div className="space-y-6">
                                    <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest mb-4 italic">Análisis de Retorta (OWR)</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">% Vol Aceite</label>
                                            <input type="number" value={owr.vOil} onChange={e => setOwr({ ...owr, vOil: e.target.value })} className="w-full input-style text-xl font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">% Vol Agua</label>
                                            <input type="number" value={owr.vWater} onChange={e => setOwr({ ...owr, vWater: e.target.value })} className="w-full input-style text-xl font-bold" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block italic text-halliburton-red">Relación Objetivo (% Aceite)</label>
                                        <div className="flex gap-2">
                                            {['70', '75', '80', '85', '90'].map(r => (
                                                <button key={r} onClick={() => setOwr({ ...owr, targetRatio: r })} className={`flex-1 py-3 rounded-xl text-[10px] font-black transition-all border ${owr.targetRatio === r ? 'bg-halliburton-red text-white border-halliburton-red shadow-lg' : 'bg-zinc-50 dark:bg-slate-900 text-zinc-400 border-zinc-200 dark:border-zinc-800'}`}>
                                                    {r}/{100 - r}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'pfmf' && (
                                <div className="space-y-6">
                                    <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest mb-4 italic">Titulación Pf / Mf</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Lectura Pf (ml)</label>
                                            <input type="number" value={titration.pf} onChange={e => setTitration({ ...titration, pf: e.target.value })} className="w-full input-style text-xl font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Lectura Mf (ml)</label>
                                            <input type="number" value={titration.mf} onChange={e => setTitration({ ...titration, mf: e.target.value })} className="w-full input-style text-xl font-bold" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Dureza Calcio (mg/L Ca++) - Opcional</label>
                                        <input type="number" value={titration.ca} onChange={e => setTitration({ ...titration, ca: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="Para remediación de cemento" />
                                    </div>
                                    <div className="p-5 bg-blue-50 dark:bg-blue-900/10 rounded-3xl border border-blue-100 dark:border-blue-900/20 text-[10px] leading-relaxed text-blue-800 dark:text-blue-300 font-bold uppercase tracking-wider">
                                        <Icon name="info" size={12} className="inline mr-2" />
                                        Asegúrese de usar H2SO4 0.02N según norma API para estos cálculos.
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'fit' && (
                                <div className="space-y-6">
                                    <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest mb-4 italic">Prueba de Integridad (FIT)</h4>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">EMW Objetivo ({unitMode === 'field' ? 'ppg' : 'g/L'})</label>
                                        <input type="number" value={fit.targetEMW} onChange={e => setFit({ ...fit, targetEMW: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Densidad Lodo Actual ({unitMode === 'field' ? 'ppg' : 'g/L'})</label>
                                        <input type="number" value={fit.currentMW} onChange={e => setFit({ ...fit, currentMW: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">TVD Zapata ({unitMode === 'field' ? 'ft' : 'm'})</label>
                                        <input type="number" value={fit.shoeTVD} onChange={e => setFit({ ...fit, shoeTVD: e.target.value })} className="w-full input-style text-xl font-bold" placeholder="0.00" />
                                    </div>
                                    <div className="p-5 bg-zinc-50 dark:bg-slate-900/60 rounded-3xl border border-zinc-100 dark:border-zinc-800/50 text-[10px] leading-relaxed text-zinc-500 font-bold uppercase tracking-wider">
                                        <Icon name="activity" size={12} className="inline mr-2" />
                                        La prueba verifica la integridad debajo de la zapata sin fracturar.
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'mixing' && (
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h4 className="text-[14px] font-black text-halliburton-red uppercase tracking-widest italic">Mezcla de Fluidos</h4>
                                        <div className="flex gap-2 bg-zinc-100 dark:bg-slate-900 p-1.5 rounded-2xl">
                                            <button onClick={() => setMixUnits({ ...mixUnits, vol: mixUnits.vol === 'm3' ? 'bbl' : 'm3' })} className="px-6 py-2.5 rounded-xl bg-zinc-800 text-white text-[11px] font-black uppercase shadow-lg hover:scale-105 transition-transform active:scale-95">{mixUnits.vol}</button>
                                            <button onClick={() => setMixUnits({ ...mixUnits, dens: mixUnits.dens === 'ppg' ? 'gL' : 'ppg' })} className="px-6 py-2.5 rounded-xl bg-zinc-800 text-white text-[11px] font-black uppercase shadow-lg hover:scale-105 transition-transform active:scale-95">{mixUnits.dens}</button>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {mix.map((f, i) => (
                                            <div key={i} className="grid grid-cols-2 gap-4 p-5 bg-zinc-50 dark:bg-slate-900/60 rounded-[2rem] border-2 border-zinc-100 dark:border-zinc-800 shadow-sm relative group/fluid">
                                                <div>
                                                    <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Vol {i + 1} ({mixUnits.vol})</label>
                                                    <input type="number" value={f.vol} onChange={e => {
                                                        const newMix = [...mix];
                                                        newMix[i].vol = e.target.value;
                                                        setMix(newMix);
                                                    }} className="w-full bg-white dark:bg-slate-800 border-2 border-zinc-200 dark:border-zinc-700 rounded-xl p-3 text-sm font-bold focus:border-halliburton-red outline-none transition-all shadow-inner" />
                                                </div>
                                                <div>
                                                    <label className="text-[13px] font-black text-zinc-500 dark:text-zinc-400 uppercase tracking-widest mb-2 block">Dens {i + 1} ({mixUnits.dens})</label>
                                                    <input type="number" value={f.dens} onChange={e => {
                                                        const newMix = [...mix];
                                                        newMix[i].dens = e.target.value;
                                                        setMix(newMix);
                                                    }} className="w-full bg-white dark:bg-slate-800 border-2 border-zinc-200 dark:border-zinc-700 rounded-xl p-3 text-sm font-bold focus:border-halliburton-red outline-none transition-all shadow-inner" />
                                                </div>
                                                {mix.length > 2 && (
                                                    <button
                                                        onClick={() => setMix(mix.filter((_, idx) => idx !== i))}
                                                        className="absolute -right-2 -top-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover/fluid:opacity-100 transition-opacity flex items-center justify-center shadow-lg"
                                                    >
                                                        <Icon name="x" size={12} />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                        <button
                                            onClick={addMixingFluid}
                                            className="w-full py-4 border-2 border-dashed border-zinc-300 dark:border-zinc-700 rounded-[2rem] text-zinc-400 hover:text-halliburton-red hover:border-halliburton-red transition-all flex items-center justify-center gap-2 font-black uppercase text-[10px] tracking-widest"
                                        >
                                            <Icon name="plus" size={16} />
                                            Agregar Fluido a la Mezcla
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Results Side */}
                        <div className={`${activeSubTab === 'conv' ? 'lg:col-span-5' : 'lg:col-span-7'} space-y-6`}>
                            {activeSubTab === 'eng' && (
                                <>
                                    <div className="bg-gradient-to-br from-halliburton-red to-[#a30000] p-10 rounded-[3.5rem] text-white shadow-2xl relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"><Icon name="droplet" size={80} /></div>
                                        <span className="text-[10px] font-black uppercase tracking-[0.3em] opacity-60">Presión Hidrostática</span>
                                        <div className="flex items-baseline gap-2 mt-2">
                                            <h5 className="text-7xl font-black italic">{getHydrostatic()}</h5>
                                            <span className="text-xl font-bold opacity-60 italic uppercase tracking-tighter">PSI</span>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-white/10 text-[10px] font-bold uppercase tracking-widest opacity-80 italic">
                                            Eq: {psiToKgCm2(getHydrostatic()).toFixed(2)} kg/cm²
                                        </div>
                                    </div>
                                    <div className="bg-zinc-900 p-10 rounded-[3.5rem] text-white shadow-2xl relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"><Icon name="database" size={80} /></div>
                                        <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">Capacidad Teórica</span>
                                        <div className="flex items-baseline gap-2 mt-2">
                                            <h5 className="text-5xl font-black italic">{((eng.diam ** 2) / 1029.4 * (unitMode === 'field' ? 1 : 0.158987 / 0.3048)).toFixed(5)}</h5>
                                            <span className="text-lg font-bold text-halliburton-red italic uppercase tracking-tighter">{unitMode === 'field' ? 'bbl/ft' : 'm³/m'}</span>
                                        </div>
                                    </div>
                                </>
                            )}

                            {activeSubTab === 'barite' && (
                                <div className="bg-zinc-900 p-12 rounded-[3.5rem] text-white flex flex-col justify-center h-full relative overflow-hidden group">
                                    <div className="absolute -right-10 -bottom-10 opacity-5 group-hover:scale-110 transition-transform"><Icon name="arrow-up-circle" size={300} /></div>
                                    <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 mb-6 block">Requerimiento de Barita</span>
                                    <div className="space-y-10">
                                        <div>
                                            <div className="flex items-baseline gap-3">
                                                <h5 className="text-8xl font-black text-halliburton-red italic">{getBariteTons()}</h5>
                                                <span className="text-2xl font-black opacity-40 uppercase italic">Tons métricas</span>
                                            </div>
                                            <p className="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mt-4">Cálculo basado en SG {barite.sg}</p>
                                        </div>
                                        <div className="p-6 bg-white/5 rounded-3xl border border-white/10 inline-block">
                                            <span className="text-[9px] font-black text-zinc-500 uppercase block mb-1">Volumen Final Estimado</span>
                                            <p className="text-xl font-black italic">
                                                {(parseFloat(barite.vol || 0) + (getBariteTons() / 4.2 * (bariteUnits.vol === 'bbl' ? 6.2898 : 1))).toFixed(2)} {bariteUnits.vol}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'slug' && (
                                <div className="bg-zinc-900 p-12 rounded-[3.5rem] text-white flex flex-col justify-center h-full relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"><Icon name="flask-conical" size={100} /></div>
                                    <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 mb-6 block">Especificación de Píldora</span>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                                        <div className="space-y-6">
                                            <div>
                                                <span className="text-[11px] font-black text-zinc-500 uppercase block mb-1">Volumen Mínimo Requerido</span>
                                                <div className="flex items-baseline gap-2 mb-4">
                                                    <h5 className="text-3xl font-black italic text-zinc-400">{getSlugResult().volReq}</h5>
                                                    <span className="text-sm font-bold opacity-30 uppercase">{unitMode === 'field' ? 'bbl' : 'm³'}</span>
                                                </div>
                                                <span className="text-[11px] font-black text-halliburton-red uppercase block mb-1">Volumen Total a Preparar</span>
                                                <div className="flex items-baseline gap-2">
                                                    <h5 className="text-5xl font-black italic">{getSlugResult().volFinal}</h5>
                                                    <span className="text-xl font-bold opacity-40 uppercase">{unitMode === 'field' ? 'bbl' : 'm³'}</span>
                                                </div>
                                            </div>
                                            <div className="p-4 bg-white/5 rounded-2xl border border-white/10">
                                                <span className="text-[10px] font-black text-zinc-400 uppercase block mb-1">Mud del Sistema Activo</span>
                                                <div className="flex items-baseline gap-2">
                                                    <h5 className="text-3xl font-black italic text-zinc-200">{getSlugResult().volInitial}</h5>
                                                    <span className="text-sm font-bold opacity-40 uppercase">{unitMode === 'field' ? 'bbl' : 'm³'}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <span className="text-[11px] font-black text-halliburton-red uppercase block mb-1">Barita Requerida</span>
                                            <div className="flex items-baseline gap-2">
                                                <h5 className="text-6xl font-black italic">{getSlugResult().tons}</h5>
                                                <span className="text-xl font-bold opacity-40 uppercase">Tons</span>
                                            </div>
                                            <p className="text-[10px] font-black text-zinc-500 mt-2 uppercase tracking-widest italic leading-tight">Mezclar v. inicial + barita para vencer la hidrostática del anular, válvulas y MPD.</p>
                                        </div>
                                    </div>

                                    {/* Visual Trend: U-Tube */}
                                    <div className="relative h-40 w-full bg-zinc-800 rounded-2xl border border-white/5 overflow-hidden p-4 flex gap-4">
                                        <div className="flex-1 flex flex-col justify-end">
                                            <div className="w-12 mx-auto bg-zinc-700 h-full rounded-t-lg relative overflow-hidden flex flex-col justify-end border-x border-white/10">
                                                <div className="w-full bg-zinc-500" style={{ height: '60%' }}></div> {/* Fluid */}
                                                <div className="w-full bg-halliburton-red" style={{ height: (getSlugResult().vol > 0 ? '20%' : '0%') }}></div> {/* Slug */}
                                                <div className="absolute top-0 left-0 right-0 py-1 text-[8px] font-black text-center text-white/40 uppercase">PIPE</div>
                                            </div>
                                        </div>
                                        <div className="flex-1 flex flex-col justify-end">
                                            <div className="w-20 mx-auto bg-zinc-700 h-[80%] rounded-t-lg relative overflow-hidden flex flex-col justify-end border-x border-white/10">
                                                <div className="w-full bg-zinc-500" style={{ height: '100%' }}></div>
                                                <div className="absolute top-0 left-0 right-0 py-1 text-[8px] font-black text-center text-white/40 uppercase">ANNULUS</div>
                                            </div>
                                        </div>
                                        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 px-3 py-1 bg-black/50 backdrop-blur-md rounded-lg text-[8px] font-black text-white/80 uppercase tracking-widest border border-white/10">Equilibrio Hidrostático</div>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'owr' && (
                                <div className="bg-zinc-900 p-12 rounded-[3.5rem] text-white flex flex-col justify-center h-full relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"><Icon name="droplet-off" size={100} /></div>
                                    <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 mb-8 block">Estado de Emulsión Inversa</span>

                                    <div className="flex items-center gap-10 mb-12">
                                        <div className="relative w-32 h-32 flex items-center justify-center">
                                            <svg className="w-full h-full transform -rotate-90">
                                                <circle cx="64" cy="64" r="58" stroke="currentColor" strokeWidth="12" fill="transparent" className="text-zinc-800" />
                                                <circle cx="64" cy="64" r="58" stroke="currentColor" strokeWidth="12" fill="transparent" className="text-halliburton-red" strokeDasharray={364.4} strokeDashoffset={364.4 - (364.4 * (getOWRResult().oilPct || 0)) / 100} />
                                            </svg>
                                            <div className="absolute inset-0 flex flex-col items-center justify-center">
                                                <span className="text-2xl font-black italic">{getOWRResult().current}</span>
                                                <span className="text-[8px] font-black uppercase text-zinc-500 tracking-widest">OWR</span>
                                            </div>
                                        </div>
                                        <div className="flex-1 space-y-6">
                                            <div>
                                                <span className="text-[10px] font-black text-zinc-500 uppercase block mb-2 tracking-widest">Tratamiento Sugerido (por bbl)</span>
                                                {parseFloat(getOWRResult().addOil) > 0 ? (
                                                    <div className="p-4 bg-halliburton-red/10 border border-halliburton-red/20 rounded-2xl flex items-center justify-between">
                                                        <span className="text-[11px] font-black uppercase tracking-wider text-halliburton-red italic">Agregar Aceite</span>
                                                        <span className="text-xl font-black text-white">{getOWRResult().addOil} <small className="text-[10px] opacity-40">BBL</small></span>
                                                    </div>
                                                ) : parseFloat(getOWRResult().addWater) > 0 ? (
                                                    <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-2xl flex items-center justify-between">
                                                        <span className="text-[11px] font-black uppercase tracking-wider text-blue-400 italic">Agregar Agua</span>
                                                        <span className="text-xl font-black text-white">{getOWRResult().addWater} <small className="text-[10px] opacity-40">BBL</small></span>
                                                    </div>
                                                ) : <div className="text-[11px] font-bold text-zinc-400 italic">Relación balanceada u objetivo alcanzado.</div>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-1 h-2 rounded-full overflow-hidden bg-zinc-800">
                                        <div className="bg-halliburton-red transition-all duration-1000" style={{ width: `${getOWRResult().oilPct}%` }}></div>
                                        <div className="bg-blue-400 transition-all duration-1000" style={{ width: `${getOWRResult().waterPct}%` }}></div>
                                    </div>
                                    <div className="flex justify-between mt-3 text-[9px] font-black uppercase tracking-widest text-zinc-600">
                                        <span>Aceite ({getOWRResult().current.split('/')[0]}%)</span>
                                        <span>Agua ({getOWRResult().current.split('/')[1]}%)</span>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'fit' && (
                                <div className="bg-zinc-900 p-12 rounded-[3.5rem] text-white flex flex-col justify-center h-full relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"><Icon name="shield-check" size={120} /></div>

                                    <div className="flex justify-between items-start mb-8">
                                        <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 block">Reporte para Supervisión</span>
                                        <button
                                            onClick={() => copyToClipboard(`REPORTE PRUEBA FIT:\n- EMW Objetivo: ${fit.targetEMW} ${unitMode === 'field' ? 'ppg' : 'g/L'}\n- Dens. Actual: ${fit.currentMW} ${unitMode === 'field' ? 'ppg' : 'g/L'}\n- TVD Zapata: ${fit.shoeTVD} ${unitMode === 'field' ? 'ft' : 'm'}\n- PRESIÓN SUPERFICIE: ${getFITResult().surfacePSI} PSI`)}
                                            className="p-3 bg-white/10 hover:bg-halliburton-red rounded-2xl transition-all shadow-lg flex items-center gap-2 text-[10px] font-black uppercase tracking-widest"
                                        >
                                            <Icon name="share-2" size={14} /> Copiar Reporte
                                        </button>
                                    </div>

                                    <div className="space-y-10">
                                        <div className="relative inline-block">
                                            <span className="text-[11px] font-black text-halliburton-red uppercase block mb-1 tracking-widest italic">Presión a aplicar en manómetro</span>
                                            <div className="flex items-baseline gap-3">
                                                <h5 className="text-8xl font-black italic text-white drop-shadow-2xl">{getFITResult().surfacePSI}</h5>
                                                <span className="text-2xl font-black text-halliburton-red uppercase italic tracking-tighter">PSI</span>
                                            </div>
                                            {unitMode === 'metric' && (
                                                <div className="text-[10px] font-bold text-zinc-500 uppercase mt-2">
                                                    Equivalente: {getFITResult().surface} kg/cm²
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-halliburton-red/10 border border-halliburton-red/20 p-5 rounded-3xl">
                                            <p className="text-[10px] font-black text-white uppercase tracking-widest mb-1">Instrucción para Pozo:</p>
                                            <p className="text-[9px] font-bold text-zinc-400 uppercase tracking-[0.1em] italic leading-relaxed">
                                                Cerrar pozo y bombear lentamente hasta alcanzar {getFITResult().surfacePSI} PSI en superficie. Mantener estable por 5 minutos para verificar integridad.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'pfmf' && (
                                <div className="bg-zinc-900 p-10 rounded-[3.5rem] text-white flex flex-col justify-center h-full relative overflow-hidden group">
                                    <div className="absolute bottom-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"><Icon name="beaker" size={120} /></div>
                                    <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 mb-6 block">Composición Iónica (mg/L)</span>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
                                        {[
                                            { label: 'Hidroxilo (OH-)', val: getPfMfResult().oh, color: 'text-halliburton-red' },
                                            { label: 'Carbonato (CO3=)', val: getPfMfResult().co3, color: 'text-zinc-200' },
                                            { label: 'Bicarb. (HCO3-)', val: getPfMfResult().hco3, color: 'text-zinc-400' }
                                        ].map(ion => (
                                            <div key={ion.label} className="p-6 bg-white/5 rounded-[2rem] border border-white/10">
                                                <span className="text-[9px] font-black text-zinc-500 uppercase block mb-1 tracking-widest">{ion.label}</span>
                                                <h5 className={`text-3xl font-black italic ${ion.color}`}>{ion.val}</h5>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <h6 className="text-[11px] font-black text-halliburton-red uppercase italic tracking-widest">Tratamiento Recomendado</h6>
                                                {isEditing && <span className="text-[8px] bg-zinc-800 px-2 py-0.5 rounded text-zinc-500 font-bold">Personalizar vista activada</span>}
                                            </div>
                                            <button
                                                onClick={() => copyToClipboard(`Pf/Mf Results:\nOH: ${getPfMfResult().oh} mg/L\nCO3: ${getPfMfResult().co3} mg/L\nHCO3: ${getPfMfResult().hco3} mg/L`)}
                                                className="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all"
                                            >
                                                <Icon name="share-2" size={14} />
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {treatmentConfig.map((treat, idx) => (
                                                <div
                                                    key={treat.id}
                                                    className={`p-5 bg-white/5 rounded-3xl border transition-all relative group/treat ${treat.visible ? 'border-white/5' : 'opacity-30 border-dashed border-zinc-700'} ${!treat.visible && !isEditing ? 'hidden' : ''}`}
                                                >
                                                    {isEditing && (
                                                        <div className="absolute -top-2 -left-2 z-10">
                                                            <button onClick={() => toggleTreatment(treat.id)} className={`p-1.5 rounded-full ${treat.visible ? 'bg-green-500' : 'bg-zinc-600'} text-white shadow-lg`}><Icon name={treat.visible ? "eye" : "eye-off"} size={10} /></button>
                                                        </div>
                                                    )}
                                                    <span className="text-[10px] font-black text-zinc-500 uppercase block mb-1">{treat.label}</span>
                                                    <div className="flex items-baseline gap-2">
                                                        <span className="text-2xl font-black text-white italic">{getPfMfResult()[treat.id]}</span>
                                                        <span className="text-[10px] font-bold text-zinc-600 uppercase">{unitMode === 'field' ? 'lb/bbl' : 'kg/m³'}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        {(parseFloat(getPfMfResult().oh) > 500 && Math.abs(2 * parseFloat(titration.pf) - parseFloat(titration.mf)) < 0.2 * parseFloat(titration.mf)) && (
                                            <div className="p-4 bg-orange-500/10 border border-orange-500/20 rounded-2xl text-[9px] font-bold text-orange-400 uppercase tracking-widest text-center">
                                                ⚠️ ALERTA: Posible contaminación por Carbonatos. Verificar con Yeso.
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'mixing' && (
                                <div className="bg-zinc-900 p-10 rounded-[3.5rem] text-white space-y-8 relative overflow-hidden h-full flex flex-col justify-center">
                                    <div className="absolute top-0 right-0 p-8 opacity-10"><Icon name="blend" size={100} /></div>
                                    <span className="text-[12px] font-black uppercase tracking-[0.3em] text-zinc-500 block">Resultado de Mezcla</span>
                                    <div className="grid grid-cols-1 gap-4">
                                        <div className="p-6 bg-white/5 rounded-[2rem] border border-white/10 flex items-center justify-between">
                                            <div>
                                                <span className="text-[11px] font-black text-halliburton-red uppercase block mb-1">Densidad Final</span>
                                                <div className="flex items-baseline gap-2">
                                                    <h5 className="text-4xl font-black italic">{getMixingResult().dens}</h5>
                                                    <span className="text-xs font-bold opacity-40 uppercase">{mixUnits.dens}</span>
                                                </div>
                                            </div>
                                            <Icon name="droplet" size={32} className="text-white/10" />
                                        </div>
                                        <div className="p-6 bg-white/5 rounded-[2rem] border border-white/10 flex items-center justify-between">
                                            <div>
                                                <span className="text-[11px] font-black text-halliburton-red uppercase block mb-1">Volumen Total</span>
                                                <div className="flex items-baseline gap-2">
                                                    <h5 className="text-4xl font-black italic">{getMixingResult().vol}</h5>
                                                    <span className="text-xs font-bold opacity-40 uppercase">{mixUnits.vol}</span>
                                                </div>
                                            </div>
                                            <Icon name="database" size={32} className="text-white/10" />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSubTab === 'conv' && (
                                <div className="grid grid-cols-1 gap-4 h-full">
                                    <div className="bg-halliburton-red/10 p-8 rounded-[2.5rem] border border-halliburton-red/20 h-full flex flex-col justify-center text-center">
                                        <span className="text-[14px] font-black text-halliburton-red uppercase block mb-6 tracking-widest">Conversiones de Campo</span>
                                        <div className="space-y-4 max-w-xs mx-auto w-full">
                                            <div className="flex justify-between items-center text-[13px] py-2 border-b border-halliburton-red/10">
                                                <span className="font-bold text-zinc-500 dark:text-zinc-400 italic">{convReverse ? 'lb/pie³ → ppg' : 'ppg → lb/pie³'}</span>
                                                <span className="font-black dark:text-white">{convReverse ? (convVal / 7.48).toFixed(2) : (convVal * 7.48).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-[13px] py-2 border-b border-halliburton-red/10">
                                                <span className="font-bold text-zinc-500 dark:text-zinc-400 italic">{convReverse ? 'gal (US) → bbl' : 'bbl → gal (US)'}</span>
                                                <span className="font-black dark:text-white">{convReverse ? (convVal / 42).toFixed(2) : (convVal * 42).toFixed(0)}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-[13px] py-2 border-b border-halliburton-red/10">
                                                <span className="font-bold text-zinc-500 dark:text-zinc-400 italic">{convReverse ? 'mts → ft' : 'ft → mts'}</span>
                                                <span className="font-black dark:text-white">{convReverse ? (convVal * 3.28084).toFixed(1) : ftToM(convVal || 0).toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div >
            );
        };

        const PiletasSystem = ({ isEditing }) => {
            const [unitMode, setUnitMode] = useState('metric'); // 'field', 'metric'
            const [isConfiguringFluids, setIsConfiguringFluids] = useState(false);
            const [showFluidStats, setShowFluidStats] = useState(false);
            const [draggingPitId, setDraggingPitId] = useState(null);
            const [resizingPitId, setResizingPitId] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [resizeStart, setResizeStart] = useState({ w: 0, h: 0, x: 0, y: 0 });
            const [historyPits, setHistoryPits] = useState(null);
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectionBox, setSelectionBox] = useState(null); // { x, y, startX, startY }
            const [groupStartStates, setGroupStartStates] = useState(null);

            const INITIAL_FLUIDS = [
                { id: 'WBM', label: 'WBM', color: 'bg-blue-600' },
                { id: 'OBM', label: 'OBM', color: 'bg-halliburton-red' },
                { id: 'KillMud', label: 'KillMud', color: 'bg-zinc-900' },
                { id: 'Gasoil', label: 'Gasoil', color: 'bg-yellow-500' }
            ];

            const INITIAL_PITS = [
                { n: 'SUCCIÓN 1', cap: 35 }, { n: 'SUCCIÓN 2', cap: 35 }, { n: 'PILDORA 1', cap: 14 },
                { n: 'INTERMEDIA 1', cap: 45 }, { n: 'INTERMEDIA 2', cap: 45 },
                { n: 'RESERVA 1', cap: 45 }, { n: 'RESERVA 2', cap: 45 }, { n: 'PILDORA 2', cap: 14 },
                { n: 'RESERVA 3', cap: 45 }, { n: 'RESERVA 4', cap: 45 },
                { n: 'NOV1', cap: 60 }, { n: 'NOV2', cap: 60 }, { n: 'NOV3', cap: 60 }, { n: 'NOV4', cap: 60 }, { n: 'NOV5', cap: 60 }
            ].map((p, i) => ({
                id: i + 1,
                name: p.n,
                vol: 0,
                maxVol: p.cap,
                density: 1.0,
                type: 'WBM',
                x: 50 + ((i % 5) * 170),
                y: 40 + (Math.floor(i / 5) * 240),
                w: 120,
                h: 105,
                rotated: false
            }));

            const [fluidSystems, setFluidSystems] = useState(() => {
                const saved = localStorage.getItem('baroid_fluid_systems_v4');
                return saved ? JSON.parse(saved) : INITIAL_FLUIDS;
            });

            const [pits, setPits] = useState(() => {
                const saved = localStorage.getItem('baroid_piletas_v8');
                return saved ? JSON.parse(saved) : INITIAL_PITS;
            });

            // The reset functionality is now handled globally at the App level
            // to ensure a complete sync of all states.

            useEffect(() => {
                localStorage.setItem('baroid_piletas_v8', JSON.stringify(pits));
            }, [pits]);

            useEffect(() => {
                localStorage.setItem('baroid_fluid_systems_v4', JSON.stringify(fluidSystems));
            }, [fluidSystems]);

            const addPit = () => {
                const newPit = {
                    id: Date.now(),
                    name: `P-${pits.length + 1}`,
                    vol: 0,
                    maxVol: 50,
                    density: 1.0,
                    type: fluidSystems[0]?.id || 'WBM',
                    x: 50,
                    y: 50,
                    rotated: false,
                    w: 130,
                    h: 220
                };

                const nextPits = [...pits, newPit];
                setPits(nextPits);

                // Si estamos en modo reordenado, también agregar al historial para no perderlo al "deshacer"
                if (historyPits) {
                    setHistoryPits([...historyPits, newPit]);
                }
            };

            const updatePit = (id, field, val) => {
                const mapper = p => {
                    if (p.id === id) {
                        const next = { ...p, [field]: val };
                        const v = parseFloat(next.vol);
                        const m = parseFloat(next.maxVol);
                        if (!isNaN(v) && !isNaN(m) && v > m && next.maxVol !== '') {
                            next.vol = next.maxVol;
                        }
                        return next;
                    }
                    return p;
                };

                setPits(pits.map(mapper));

                // Mantener sincronizados los DATOS (nombre, vol, densidad, etc) en el historial
                // pero NO las posiciones si ya estamos en modo reordenado.
                if (historyPits) {
                    setHistoryPits(historyPits.map(mapper));
                }
            };

            const reorderPits = () => {
                setHistoryPits(JSON.parse(JSON.stringify(pits)));

                // Sort by Y position mainly, then X to preserve general user layout
                const sortedPits = [...pits].sort((a, b) => {
                    if (Math.abs(a.y - b.y) < 100) return a.x - b.x;
                    return a.y - b.y;
                });

                const COLS = 5;
                const SPACING_X = 170; // Original spacing
                const SPACING_Y = 240; // Original spacing
                const OFFSET_X = 50;
                const OFFSET_Y = 40;

                const newPits = sortedPits.map((p, i) => {
                    const row = Math.floor(i / COLS);
                    const col = i % COLS;
                    return {
                        ...p,
                        x: OFFSET_X + (col * SPACING_X),
                        y: OFFSET_Y + (row * SPACING_Y),
                        w: 120,
                        h: 105,
                        rotated: false
                    };
                });

                setPits(newPits);
            };

            const exportToPDF = () => {
                if (typeof html2pdf === 'undefined') {
                    alert("Error: Librería de PDF no cargada. Verifique su conexión.");
                    return;
                }

                const date = new Date().toLocaleString('es-AR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });

                const colorMap = {
                    'bg-blue-600': '#2563eb', 'bg-halliburton-red': '#CC0000', 'bg-zinc-900': '#18181b',
                    'bg-yellow-500': '#eab308', 'bg-zinc-700': '#3f3f46', 'bg-sky-400': '#38bdf8',
                    'bg-orange-600': '#ea580c', 'bg-emerald-600': '#059669', 'bg-amber-500': '#f59e0b',
                    'bg-purple-600': '#9333ea', 'bg-zinc-500': '#71717a'
                };

                const currentUnit = unitMode === 'metric' ? 'm³' : 'bbl';
                const totalVolReport = pits.reduce((acc, p) => acc + (parseFloat(p.vol) || 0), 0);
                const totalMaxReport = pits.reduce((acc, p) => acc + (parseFloat(p.maxVol) || 0), 0);
                const occupancy = ((totalVolReport / (totalMaxReport || 1)) * 100).toFixed(1);

                // CONTENEDOR TEMPORAL (Fixed para evitar problemas de renderizado en blanco)
                const reportContainer = document.createElement('div');
                reportContainer.id = "pdf-export-container";
                reportContainer.style.cssText = "position: fixed; top: 0; left: 0; width: 1080px; z-index: -100; opacity: 0.01; padding: 0; margin: 0; background: white; color: black; font-family: 'Inter', sans-serif; pointer-events: none;";

                const innerBody = document.createElement('div');
                innerBody.style.cssText = "padding: 30px; box-sizing: border-box; width: 100%; color: black; font-family: 'Inter', sans-serif; background: white;";

                const header = `
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #CC0000; padding-bottom: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: #CC0000; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 950; font-size: 28px; font-family: Outfit;">H</div>
                            <h1 style="margin: 0; font-size: 24px; font-weight: 950; color: #1e293b; font-family: Outfit;">INVENTARIO DE PILETAS | BAROID</h1>
                        </div>
                        <div style="font-family: Outfit; font-size: 18px; font-weight: 950; color: #CC0000;">${date}</div>
                    </div>
                `;

                const kpiStrip = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        ${[
                        { l: 'Volumen Total', v: unitMode === 'metric' ? totalVolReport.toFixed(1) : (totalVolReport / 0.158987).toFixed(0), u: currentUnit, c: '#CC0000' },
                        { l: 'Capacidad', v: unitMode === 'metric' ? totalMaxReport.toFixed(1) : (totalMaxReport / 0.158987).toFixed(0), u: currentUnit, c: '#1e293b' },
                        { l: 'Ocupación', v: occupancy, u: '%', c: '#1e293b' },
                        { l: 'Dens. Media', v: displayDens(totalVolReport > 0 ? pits.reduce((acc, p) => acc + (parseFloat(p.vol) || 0) * (parseFloat(p.density) || 1), 0) / totalVolReport : 1), u: getDensLabel(), c: '#1e293b' }
                    ].map(k => `
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; border-left: 5px solid ${k.c};">
                                <div style="font-size: 9px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 5px;">${k.l}</div>
                                <div style="font-size: 26px; font-weight: 950; color: ${k.c}; font-family: Outfit;">${k.v} <small style="font-size: 12px; color: #94a3b8;">${k.u}</small></div>
                            </div>
                        `).join('')}
                    </div>
                `;

                const sysLine = `
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px;">
                        ${fluidSystems.map(sys => {
                    const volS = pits.filter(p => p.type === sys.id).reduce((acc, p) => acc + (parseFloat(p.vol) || 0), 0);
                    if (volS === 0) return '';
                    return `<div style="display: flex; align-items: center; gap: 5px; background: #f8fafc; padding: 4px 10px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="width: 8px; height: 8px; border-radius: 2px; background: ${colorMap[sys.color]};"></div>
                                <span style="font-size: 9px; font-weight: 800; color: #475569;">${sys.label}: <strong style="color:#0f172a">${unitMode === 'metric' ? volS.toFixed(1) : (volS / 0.158987).toFixed(0)}</strong></span>
                            </div>`;
                }).join('')}
                    </div>
                `;

                const sortedPits = [...pits].sort((a, b) => (a.y - b.y) || (a.x - b.x)).slice(0, 36);
                const grid = `
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
                        ${sortedPits.map(p => {
                    const vmax = parseFloat(p.maxVol) || 1;
                    const level = Math.min(((parseFloat(p.vol) || 0) / vmax) * 100, 100);
                    const system = fluidSystems.find(s => s.id === p.type) || fluidSystems[0];
                    const c = colorMap[system.color] || '#333';
                    return `
                                <div style="border: 2px solid #e2e8f0; border-radius: 15px; padding: 10px; background: white;">
                                    <div style="font-size: 12px; font-weight: 950; text-align: center; font-family: Outfit; border-bottom: 2px solid #f1f5f9; padding-bottom: 6px; margin-bottom: 10px; text-transform: uppercase;">${p.name}</div>
                                    <div style="height: 80px; background: #f1f5f9; border-radius: 10px; position: relative; overflow: hidden; border: 1.5px solid #e2e8f0;">
                                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: ${c}; height: ${level}%;"></div>
                                        <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;">
                                            <div style="background: white; border: 2.5px solid black; padding: 4px 10px; border-radius: 10px; font-size: 22px; font-weight: 950; font-family: Outfit; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">${p.vol}</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; background: #0f172a; border-radius: 10px; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left;">
                                            <div style="font-size: 7px; font-weight: 900; color: #64748b;">DENSIDAD</div>
                                            <div style="font-size: 17px; font-weight: 950; color: white; font-family: Outfit;">${displayDens(p.density)}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 7px; font-weight: 900; color: #64748b;">CAP</div>
                                            <div style="font-size: 17px; font-weight: 950; color: #cbd5e1; font-family: Outfit;">${p.maxVol}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;

                innerBody.innerHTML = header + kpiStrip + sysLine + grid;
                reportContainer.appendChild(innerBody);
                document.body.appendChild(reportContainer);

                const opt = {
                    margin: 5,
                    filename: `Reporte_Piletas_${date.replace(/[/:\s]/g, '_')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        width: 1080,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };

                setTimeout(() => {
                    html2pdf().set(opt).from(reportContainer).save().then(() => {
                        document.body.removeChild(reportContainer);
                    }).catch(err => {
                        console.error("Error capturando PDF:", err);
                        document.body.removeChild(reportContainer);
                    });
                }, 1500); // Más tiempo para evitar el blanco
            };




            const undoReorder = () => {
                if (historyPits) {
                    setPits(historyPits);
                    setHistoryPits(null);
                }
            };

            const deletePit = (id) => {
                const isSelected = selectedIds.includes(id);
                const idsToDelete = isSelected ? selectedIds : [id];
                const count = idsToDelete.length;
                const msg = count > 1 ? `¿Eliminar las ${count} piletas seleccionadas?` : '¿Eliminar esta pileta?';

                if (confirm(msg)) {
                    const filterer = p => !idsToDelete.includes(p.id);
                    setPits(pits.filter(filterer));
                    if (historyPits) {
                        setHistoryPits(historyPits.filter(filterer));
                    }
                    setSelectedIds(prev => prev.filter(sid => !idsToDelete.includes(sid)));
                }
            };

            const handleMouseDown = (e, id = null) => {
                if (e.target.closest('input') || e.target.closest('button')) return;

                if (id) {
                    e.stopPropagation();
                    let nextSelection = selectedIds;
                    const isNowSelected = selectedIds.includes(id);

                    if (e.shiftKey) {
                        nextSelection = isNowSelected ? selectedIds.filter(i => i !== id) : [...selectedIds, id];
                        setSelectedIds(nextSelection);
                    } else if (!isNowSelected) {
                        nextSelection = [id];
                        setSelectedIds(nextSelection);
                    }

                    // Save initial state for group operations
                    const startData = {};
                    pits.forEach(p => {
                        if (nextSelection.includes(p.id)) {
                            startData[p.id] = { x: p.x, y: p.y, w: p.w, h: p.h };
                        }
                    });
                    setGroupStartStates(startData);

                    const pit = pits.find(p => p.id === id);
                    if (e.target.closest('.resize-handle')) {
                        setResizingPitId(id);
                        setResizeStart({ w: pit.w, h: pit.h, x: e.clientX, y: e.clientY });
                    } else {
                        setDraggingPitId(id);
                        setDragOffset({ x: e.clientX - pit.x, y: e.clientY - pit.y });
                    }
                } else {
                    if (!e.shiftKey) setSelectedIds([]);
                    setSelectionBox({ x: e.clientX, y: e.clientY, startX: e.clientX, startY: e.clientY, w: 0, h: 0 });
                }
            };

            const handleMouseMove = (e) => {
                const canvasEl = document.getElementById('piletas-canvas');
                if (!canvasEl) return;
                const canvasRect = canvasEl.getBoundingClientRect();
                const margin = 20;

                if (selectionBox) {
                    const currentX = e.clientX;
                    const currentY = e.clientY;
                    const x = Math.min(currentX, selectionBox.startX);
                    const y = Math.min(currentY, selectionBox.startY);
                    const w = Math.abs(currentX - selectionBox.startX);
                    const h = Math.abs(currentY - selectionBox.startY);
                    setSelectionBox({ ...selectionBox, x, y, w, h });

                    const boxInCanvas = {
                        left: x - canvasRect.left,
                        top: y - canvasRect.top,
                        right: (x + w) - canvasRect.left,
                        bottom: (y + h) - canvasRect.top
                    };

                    const pitsInBox = pits.filter(p => {
                        const pw = p.w + 24;
                        const ph = 150;
                        return (p.x < boxInCanvas.right && p.x + pw > boxInCanvas.left &&
                            p.y < boxInCanvas.bottom && p.y + ph > boxInCanvas.top);
                    }).map(p => p.id);
                    setSelectedIds(pitsInBox);
                } else if (draggingPitId && groupStartStates) {
                    const dx = e.clientX - (groupStartStates[draggingPitId].x + dragOffset.x);
                    const dy = e.clientY - (groupStartStates[draggingPitId].y + dragOffset.y);

                    setPits(prevPits => prevPits.map(p => {
                        if (selectedIds.includes(p.id) && groupStartStates[p.id]) {
                            const s = groupStartStates[p.id];
                            return {
                                ...p,
                                x: Math.max(margin, Math.min(s.x + dx, canvasRect.width - margin - (p.w + 24))),
                                y: Math.max(margin, Math.min(s.y + dy, canvasRect.height - margin - 150))
                            };
                        }
                        return p;
                    }));
                } else if (resizingPitId && groupStartStates) {
                    const dx = e.clientX - resizeStart.x;
                    const dy = e.clientY - resizeStart.y;

                    setPits(prevPits => prevPits.map(p => {
                        if (selectedIds.includes(p.id) && groupStartStates[p.id]) {
                            const s = groupStartStates[p.id];
                            return {
                                ...p,
                                w: Math.max(120, s.w + dx),
                                h: Math.max(105, s.h + dy)
                            };
                        }
                        return p;
                    }));
                }
            };

            const handleMouseUp = () => {
                setDraggingPitId(null);
                setResizingPitId(null);
                setSelectionBox(null);
                setGroupStartStates(null);
            };

            const handleEnter = (e) => {
                if (e.key === 'Enter') e.target.blur();
            };

            const addFluidSystem = () => {
                const id = `SYS_${Date.now()}`;
                setFluidSystems([...fluidSystems, { id, label: 'Nuevo', color: 'bg-zinc-500' }]);
            };

            const updateFluidSystem = (id, field, val) => {
                setFluidSystems(fluidSystems.map(s => s.id === id ? { ...s, [field]: val } : s));
            };

            const deleteFluidSystem = (id) => {
                if (fluidSystems.length <= 1) return alert('Debe haber al menos un sistema.');
                if (confirm('¿Eliminar este sistema? Las piletas que lo usen volverán al primero.')) {
                    setFluidSystems(fluidSystems.filter(s => s.id !== id));
                    setPits(pits.map(p => p.type === id ? { ...p, type: fluidSystems.find(s => s.id !== id).id } : p));
                }
            };

            const totalVol = pits.reduce((acc, p) => acc + (parseFloat(p.vol) || 0), 0);
            const totalMax = pits.reduce((acc, p) => acc + (parseFloat(p.maxVol) || 0), 0);
            const avgSG = totalVol > 0
                ? pits.reduce((acc, p) => acc + ((parseFloat(p.vol) || 0) * (parseFloat(p.density) || 1)), 0) / totalVol
                : 1.0;

            const systemMaxCap = Math.max(...pits.map(p => parseFloat(p.maxVol) || 1), 100);

            const displayDens = (sg) => {
                return unitMode === 'metric' ? (sg * 1000).toFixed(0) : (sg * 8.33).toFixed(2);
            };
            const parseDens = (val) => {
                const num = parseFloat(val) || 0;
                return unitMode === 'metric' ? num / 1000 : num / 8.33;
            };
            const getDensLabel = () => unitMode === 'metric' ? 'g/L' : 'ppg';

            const availableColors = [
                'bg-blue-600', 'bg-halliburton-red', 'bg-zinc-900', 'bg-yellow-500', 'bg-zinc-700', 'bg-sky-400',
                'bg-orange-600', 'bg-emerald-600', 'bg-amber-500', 'bg-purple-600', 'bg-zinc-500'
            ];

            const statsBySystem = fluidSystems.map(sys => {
                const vol = pits.filter(p => p.type === sys.id).reduce((acc, p) => acc + (parseFloat(p.vol) || 0), 0);
                const cap = pits.filter(p => p.type === sys.id).reduce((acc, p) => acc + (parseFloat(p.maxVol) || 0), 0);
                return { ...sys, vol, cap };
            });

            return (
                <div className="animate-fade-in space-y-4 pb-32 select-none" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp}>
                    {/* Simplified Header */}
                    <div className="bg-white dark:bg-slate-900/80 p-6 rounded-[3rem] border border-zinc-100 dark:border-zinc-800 shadow-sm flex flex-col gap-6">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="flex bg-zinc-100 dark:bg-slate-800 p-1 rounded-xl border border-zinc-200 dark:border-zinc-700">
                                    <button onClick={() => setUnitMode('field')} className={`px-5 py-2 rounded-lg text-xs font-black uppercase transition-all ${unitMode === 'field' ? 'bg-halliburton-red text-white' : 'text-zinc-500'}`}>ppg</button>
                                    <button onClick={() => setUnitMode('metric')} className={`px-5 py-2 rounded-lg text-xs font-black uppercase transition-all ${unitMode === 'metric' ? 'bg-halliburton-red text-white' : 'text-zinc-500'}`}>g/L</button>
                                </div>
                                <button onClick={() => setIsConfiguringFluids(!isConfiguringFluids)} className="bg-white dark:bg-slate-800 text-zinc-600 dark:text-zinc-400 px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-sm border border-zinc-100 dark:border-zinc-700 flex items-center gap-2 hover:bg-zinc-50 dark:hover:bg-slate-700 transition-colors">
                                    <Icon name="sliders" size={14} /> {isConfiguringFluids ? 'Cerrar' : 'Config. Fluidos'}
                                </button>

                                <button
                                    onClick={historyPits ? undoReorder : reorderPits}
                                    className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-sm border transition-all flex items-center gap-2 ${historyPits ? 'bg-amber-50 dark:bg-amber-900/20 text-amber-600 border-amber-200' : 'bg-white dark:bg-slate-800 text-zinc-600 dark:text-zinc-400 border-zinc-100 dark:border-zinc-700'}`}
                                >
                                    <Icon name={historyPits ? "mouse-pointer" : "grid"} size={14} />
                                    {historyPits ? 'Personalizado' : 'Reordenar'}
                                </button>


                                <button onClick={addPit} className="bg-white dark:bg-slate-800 text-zinc-600 dark:text-zinc-400 px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-sm border border-zinc-100 dark:border-zinc-700 flex items-center gap-2 hover:bg-zinc-50 dark:hover:bg-slate-700 transition-colors">
                                    <Icon name="plus" size={14} /> Añadir Tanque
                                </button>

                                <button onClick={() => setShowFluidStats(!showFluidStats)} className={`px-6 py-3 rounded-xl text-xs font-black uppercase shadow-md flex items-center gap-2 transition-all transform hover:scale-105 ${showFluidStats ? 'bg-halliburton-red text-white' : 'bg-zinc-900 text-white'}`}>
                                    <Icon name="bar-chart-2" size={16} /> Ver Dashboard
                                </button>
                            </div>

                            {/* Summary Integrated */}
                            <div className="flex flex-wrap gap-8 items-center bg-zinc-50 dark:bg-slate-800/50 px-8 py-3 rounded-[2rem] border border-zinc-100 dark:border-zinc-800">
                                {[
                                    { label: 'Vol. Total', val: unitMode === 'metric' ? totalVol.toFixed(1) : (totalVol / 0.158987).toFixed(0), unit: unitMode === 'metric' ? 'm³' : 'bbl', color: 'text-halliburton-red' },
                                    { label: 'Dens. Media', val: displayDens(avgSG), unit: getDensLabel() },
                                    { label: 'Ocupación', val: ((totalVol / (totalMax || 1)) * 100).toFixed(1), unit: '%' }
                                ].map((stat, i) => (
                                    <div key={i} className="flex items-baseline gap-2">
                                        <span className="text-[10px] font-black text-zinc-400 uppercase tracking-widest">{stat.label}:</span>
                                        <span className={`text-xl font-black italic ${stat.color || 'dark:text-white'}`}>{stat.val}</span>
                                        <span className="text-[10px] font-bold text-zinc-400 uppercase">{stat.unit}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Fluid Volume Dashboard */}
                    {showFluidStats && (
                        <div className="bg-white dark:bg-slate-900 p-8 rounded-[3rem] border-2 border-zinc-100 dark:border-zinc-800 shadow-2xl animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                            {statsBySystem.map(sys => (
                                <div key={sys.id} className="p-6 bg-zinc-50 dark:bg-slate-800/50 rounded-2xl border border-zinc-100 dark:border-zinc-700 flex flex-col gap-4">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-4 h-4 rounded-full ${sys.color}`}></div>
                                        <span className="text-sm font-black uppercase tracking-widest text-zinc-600 dark:text-zinc-300">{sys.label}</span>
                                    </div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-3xl font-black italic text-zinc-900 dark:text-white">
                                            {unitMode === 'metric' ? sys.vol.toFixed(1) : (sys.vol / 0.158987).toFixed(0)}
                                        </span>
                                        <span className="text-[10px] font-bold text-zinc-400 uppercase">{unitMode === 'metric' ? 'm³' : 'bbl'}</span>
                                    </div>
                                    <div className="w-full h-2 bg-zinc-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                        <div className={`h-full ${sys.color}`} style={{ width: `${Math.min((sys.vol / (sys.cap || 1)) * 100, 100)}%` }}></div>
                                    </div>
                                    <span className="text-[9px] font-black text-zinc-400 uppercase">Cap: {unitMode === 'metric' ? sys.cap.toFixed(1) : (sys.cap / 0.158987).toFixed(0)} {unitMode === 'metric' ? 'm³' : 'bbl'}</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Fluid Config Panel */}
                    {isConfiguringFluids && (
                        <div className="bg-zinc-100 dark:bg-slate-950 p-8 rounded-[3rem] border-2 border-dashed border-zinc-200 dark:border-zinc-800 animate-fade-in shadow-inner">
                            <div className="flex flex-wrap gap-4">
                                {fluidSystems.map(sys => (
                                    <div key={sys.id} className="bg-white dark:bg-slate-900 p-3 pl-5 rounded-2xl flex items-center gap-4 border border-zinc-100 dark:border-zinc-800 shadow-sm">
                                        <div className="relative group/color">
                                            <div className={`w-8 h-8 rounded-xl ${sys.color} shadow-inner`}></div>
                                            <div className="absolute top-0 left-0 w-full h-full opacity-0 group-hover/color:opacity-100 flex flex-wrap gap-1 p-1 bg-white shadow-2xl rounded-xl z-50 transition-opacity">
                                                {availableColors.map(c => <button key={c} onClick={() => updateFluidSystem(sys.id, 'color', c)} className={`w-3 h-3 ${c} rounded-sm`}></button>)}
                                            </div>
                                        </div>
                                        <input value={sys.label} onChange={e => updateFluidSystem(sys.id, 'label', e.target.value)} className="bg-transparent border-none text-[12px] font-black uppercase w-24 focus:ring-0" />
                                        <button onClick={() => deleteFluidSystem(sys.id)} className="text-zinc-300 hover:text-red-500 transition-colors"><Icon name="x" size={18} /></button>
                                    </div>
                                ))}
                                <button onClick={addFluidSystem} className="text-xs font-black text-halliburton-red hover:text-red-700 flex items-center gap-2 p-4 transition-colors"><Icon name="plus-circle" size={20} /> Nuevo Sistema</button>
                            </div>
                        </div>
                    )}

                    {/* FREE LAYOUT CANVAS */}
                    <div
                        id="piletas-canvas"
                        onMouseDown={(e) => handleMouseDown(e)}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        className="relative bg-zinc-50 dark:bg-slate-950/40 rounded-[4rem] border-2 border-zinc-100 dark:border-zinc-800 min-h-[1200px] shadow-inner p-10 mb-20 overflow-visible"
                        style={{ cursor: (draggingPitId || resizingPitId) ? (resizingPitId ? 'se-resize' : 'grabbing') : 'default' }}
                    >
                        <div className="absolute inset-0 opacity-[0.08] pointer-events-none" style={{ backgroundImage: 'radial-gradient(#52525b 1.5px, transparent 1.5px)', backgroundSize: '40px 40px' }}></div>

                        {/* Selection Box Overlay */}
                        {selectionBox && (
                            <div
                                className="absolute bg-blue-500/10 border border-blue-500/50 z-[100] pointer-events-none rounded-sm"
                                style={{
                                    left: selectionBox.x - (document.getElementById('piletas-canvas')?.getBoundingClientRect().left || 0),
                                    top: selectionBox.y - (document.getElementById('piletas-canvas')?.getBoundingClientRect().top || 0),
                                    width: selectionBox.w,
                                    height: selectionBox.h
                                }}
                            />
                        )}

                        {pits.map(p => {
                            const isSelected = selectedIds.includes(p.id);
                            const curMax = parseFloat(p.maxVol) || 1;
                            const curVol = parseFloat(p.vol) || 0;
                            const fillPct = Math.min((curVol / curMax) * 100, 100);
                            const currentType = fluidSystems.find(t => t.id === p.type) || fluidSystems[0];

                            // Proportional scaling that respects extreme aspect ratios
                            const baseW = 130;
                            const baseH = 220;
                            const wScale = p.w / baseW;
                            const hScale = p.h / baseH;
                            const globalScale = Math.min(wScale, hScale, 1.3);
                            const innerH = p.h;

                            return (
                                <div
                                    key={p.id}
                                    id={`pit-${p.id}`}
                                    onMouseDown={(e) => handleMouseDown(e, p.id)}
                                    className={`absolute ${isSelected ? 'ring-4 ring-blue-500/30 rounded-[22px]' : ''}`}
                                    style={{
                                        left: `${p.x}px`,
                                        top: `${p.y}px`,
                                        zIndex: (draggingPitId === p.id || resizingPitId === p.id) ? 1000 : Math.floor(p.w * p.h),
                                        transition: (draggingPitId || resizingPitId || selectionBox) ? 'none' : 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                                    }}
                                >
                                    <div
                                        className={`relative bg-white dark:bg-slate-900 border-[3px] shadow-2xl group/pit ${isSelected ? 'border-blue-500 shadow-blue-500/20' : 'border-zinc-300 dark:border-slate-700 shadow-black/10'} ${draggingPitId === p.id ? 'shadow-red-500/20' : ''}`}
                                        style={{
                                            width: `${p.w + (24 * globalScale)}px`,
                                            padding: `${12 * globalScale}px`,
                                            borderRadius: `${20 * globalScale}px`,
                                            transition: (resizingPitId === p.id) ? 'none' : 'transform 0.2s',
                                            marginTop: '8px' // Space for the hook
                                        }}
                                    >
                                        {/* Subtle Clip 'Hook' Drag Handle */}
                                        <div className="move-handle absolute -top-3 left-1/2 -translate-x-1/2 w-10 h-4 bg-zinc-200 dark:bg-slate-700 rounded-t-md border-x border-t border-zinc-300 dark:border-slate-600 flex flex-col gap-0.5 items-center justify-center cursor-grab active:cursor-grabbing shadow-sm z-20 hover:bg-zinc-100 dark:hover:bg-slate-600 transition-colors opacity-80 hover:opacity-100">
                                            <div className="w-5 h-0.5 bg-zinc-400 dark:bg-slate-500 rounded-full"></div>
                                            <div className="w-5 h-0.5 bg-zinc-400 dark:bg-slate-500 rounded-full opacity-30"></div>
                                        </div>

                                        <div className="flex items-center gap-1 px-1" style={{ marginBottom: `${8 * globalScale}px` }}>
                                            <input
                                                value={p.name}
                                                onChange={e => updatePit(p.id, 'name', e.target.value)}
                                                onKeyDown={handleEnter}
                                                style={{ fontSize: `${Math.max(13, 11 * globalScale)}px`, width: '100%' }}
                                                className="bg-transparent border-none font-black uppercase text-zinc-500 focus:ring-0 truncate italic tracking-wider transition-colors mr-2 text-left"
                                            />
                                        </div>

                                        <button
                                            onClick={() => deletePit(p.id)}
                                            className="absolute -top-2 -right-2 bg-white dark:bg-slate-800 text-zinc-400 hover:text-red-500 hover:scale-110 transition-all p-1.5 rounded-full border border-zinc-200 dark:border-zinc-700 shadow-sm opacity-0 group-hover/pit:opacity-100 z-50"
                                        >
                                            <Icon name="trash-2" size={14} />
                                        </button>

                                        <div
                                            className="relative bg-zinc-100 dark:bg-slate-800 border-[1.5px] border-zinc-200 dark:border-zinc-700 overflow-hidden flex flex-col justify-end shadow-inner"
                                            style={{
                                                width: `${p.w}px`,
                                                height: `${p.h}px`,
                                                borderRadius: `${14 * globalScale}px`,
                                                transition: (resizingPitId === p.id) ? 'none' : 'all 0.3s'
                                            }}
                                        >
                                            <div
                                                className={`w-full transition-all duration-1000 ease-in-out ${currentType.color} relative pt-1`}
                                                style={{ height: `${fillPct}%` }}
                                            >
                                                <div className="absolute top-0 left-0 right-0 bg-white/20 animate-pulse" style={{ height: `${Math.min(6, 6 * hScale)}px` }}></div>
                                            </div>

                                            {/* Value Overlay - Pushed to top on compact view to avoid overlap */}
                                            <div className={`absolute inset-0 flex flex-col items-center p-2 text-center pointer-events-none ${innerH < 120 ? 'justify-start pt-1' : 'justify-center'}`}>
                                                <div className="flex flex-col items-center pointer-events-auto w-full">
                                                    <div className={`flex items-baseline justify-center gap-1 w-full backdrop-blur-[3px] rounded-xl py-1 px-2 border border-white/20 shadow-sm transition-all ${((currentType.color === 'bg-zinc-900' && fillPct > 80) || (currentType.color !== 'bg-zinc-900' && fillPct > 82)) ? 'bg-black/40' : 'bg-black/20 dark:bg-white/10'}`}>
                                                        <input
                                                            type="number"
                                                            value={p.vol}
                                                            onChange={e => updatePit(p.id, 'vol', e.target.value)}
                                                            onKeyDown={handleEnter}
                                                            style={{
                                                                fontSize: `${Math.max(18, Math.min(32 * globalScale, innerH > 60 ? 32 * globalScale : innerH * 0.5))}px`,
                                                                lineHeight: 1,
                                                                textShadow: ((currentType.color === 'bg-zinc-900' && fillPct > 80) || (currentType.color !== 'bg-zinc-900' && fillPct > 82)) ? '0 2px 4px rgba(0,0,0,0.5)' : 'none'
                                                            }}
                                                            className={`bg-transparent border-none text-center font-black focus:ring-0 ${((currentType.color === 'bg-zinc-900' && fillPct > 80) || (currentType.color !== 'bg-zinc-900' && fillPct > 82)) ? 'text-white' : 'text-zinc-900 dark:text-white'} w-full transition-colors`}
                                                        />
                                                        {innerH > 75 && (
                                                            <span style={{ fontSize: `${Math.max(12, 11 * globalScale)}px` }}
                                                                className={`font-black uppercase tracking-widest ${((currentType.color === 'bg-zinc-900' && fillPct > 80) || (currentType.color !== 'bg-zinc-900' && fillPct > 82)) ? 'text-white/80' : 'text-zinc-600 dark:text-white/80'}`}>
                                                                {unitMode === 'metric' ? 'm³' : 'bbl'}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bottom Details - Redesigned to fix clipping and improve visibility */}
                                            <div className={`absolute bottom-1 inset-x-1 flex justify-between items-center bg-black/60 backdrop-blur-lg border border-white/10 transition-all ${innerH < 65 ? 'opacity-0 scale-95 pointer-events-none' : 'opacity-100'}`}
                                                style={{ padding: `${3 * globalScale}px ${14 * globalScale}px`, borderRadius: `${10 * globalScale}px` }}>
                                                <div className="flex flex-col items-baseline leading-none">
                                                    <span className="font-black text-white/50 uppercase tracking-tighter" style={{ fontSize: `${Math.max(9, 8 * globalScale)}px` }}>{getDensLabel()}</span>
                                                    <input
                                                        value={displayDens(p.density)}
                                                        onChange={e => updatePit(p.id, 'density', parseDens(e.target.value))}
                                                        style={{ fontSize: `${Math.max(13, 11 * globalScale)}px`, textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}
                                                        className="w-12 bg-transparent border-none font-bold text-white p-0 focus:ring-0 leading-none"
                                                    />
                                                </div>
                                                <div className="flex flex-col items-end leading-none">
                                                    <span className="font-black text-white/50 uppercase tracking-tighter" style={{ fontSize: `${Math.max(9, 8 * globalScale)}px` }}>CAP</span>
                                                    <input
                                                        value={p.maxVol}
                                                        onChange={e => updatePit(p.id, 'maxVol', e.target.value)}
                                                        style={{ fontSize: `${Math.max(13, 11 * globalScale)}px`, textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}
                                                        className="w-12 bg-transparent border-none font-bold text-right text-white p-0 focus:ring-0 leading-none"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* High-Contrast Fluid Selector (Dropdown Visual) */}
                                        <div className="relative" style={{ marginTop: `${8 * globalScale}px` }}>
                                            <select
                                                value={p.type}
                                                onChange={e => updatePit(p.id, 'type', e.target.value)}
                                                style={{
                                                    fontSize: `${Math.max(12, 9 * globalScale)}px`,
                                                    padding: `${6 * globalScale}px ${24 * globalScale}px ${6 * globalScale}px ${10 * globalScale}px`,
                                                    borderRadius: `${10 * globalScale}px`
                                                }}
                                                className="w-full bg-zinc-50 dark:bg-slate-800/80 border border-zinc-200 dark:border-zinc-700 font-black uppercase text-zinc-800 dark:text-zinc-100 focus:ring-2 focus:ring-halliburton-red/30 transition-all appearance-none cursor-pointer shadow-sm hover:bg-white dark:hover:bg-slate-700"
                                            >
                                                {fluidSystems.map(fs => (
                                                    <option key={fs.id} value={fs.id} className="bg-white dark:bg-slate-900 text-zinc-900 dark:text-white">{fs.label}</option>
                                                ))}
                                            </select>
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-400 dark:text-zinc-500">
                                                <Icon name="chevron-down" size={Math.max(12, 10 * globalScale)} />
                                            </div>
                                        </div>

                                        {/* Resize Handle - Constant Size */}
                                        <div className="resize-handle absolute -bottom-2 -right-2 w-8 h-8 bg-zinc-600 rounded-full border-2 border-white dark:border-slate-950 flex items-center justify-center cursor-se-resize shadow-lg opacity-0 group-hover/pit:opacity-100 transition-all z-50 hover:bg-halliburton-red hover:scale-110">
                                            <Icon name="maximize-2" size={14} className="text-white rotate-90" />
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const InventoryConciliation = ({ isEditing }) => {
            const [products, setProducts] = useState(() => {
                const saved = localStorage.getItem('baroid_products_inventory_v2');
                return saved ? JSON.parse(saved) : [
                    { id: '1', name: 'LIME FG – Cal', factor: 20, order: 1 },
                    { id: '2', name: 'BARABLOK™ 400 NA', factor: 25, order: 2 },
                    { id: '3', name: 'BARACARB®-DF FINE', factor: 25, order: 3 },
                    { id: '4', name: 'BARACARB®-DF MEDIUM', factor: 25, order: 4 },
                    { id: '5', name: 'BARACARB®-DF COARSE', factor: 25, order: 5 },
                    { id: '6', name: 'GELTONE® II', factor: 22.7, order: 6 },
                    { id: '7', name: 'BDF™-965 FINE', factor: 25, order: 7 },
                    { id: '8', name: 'BDF™-965 MEDIUM', factor: 25, order: 8 },
                    { id: '9', name: 'BaraShield®-982', factor: 22.7, order: 9 },
                    { id: '10', name: 'BaraShield®-981', factor: 22.7, order: 10 },
                    { id: '11', name: 'BaraFLC®-903', factor: 22.7, order: 11 },
                    { id: '12', name: 'BaraSeal™-957', factor: 22.7, order: 12 },
                    { id: '13', name: 'STOPPIT™', factor: 22.7, order: 13 },
                    { id: '14', name: 'OBTURANTE MEZCLA', factor: 25, order: 14 },
                    { id: '15', name: 'EZ MUL® LA', factor: 1, order: 15 },
                    { id: '16', name: 'CLAY GRABBER®', factor: 18.9, order: 16 },
                    { id: '17', name: 'CLAY SYNC™ II', factor: 22.7, order: 17 },
                    { id: '18', name: 'BARA-DEFOAM® HP', factor: 18.9, order: 18 },
                    { id: '19', name: 'OMC® 3', factor: 25, order: 19 },
                    { id: '20', name: 'THERMA-THIN YPF', factor: 18.9, order: 20 },
                    { id: '21', name: 'XLR-RATE™', factor: 1, order: 21 },
                    { id: '22', name: 'DRILTREAT®', factor: 1, order: 22 },
                    { id: '23', name: 'INVERMUL® LA', factor: 1, order: 23 },
                    { id: '24', name: 'RM-63™', factor: 208, order: 24 },
                    { id: '25', name: 'BAROFIBRE®', factor: 11.34, order: 25 },
                    { id: '26', name: 'BARAZAN® D PLUS', factor: 25, order: 26 },
                    { id: '27', name: 'CARBONOX®', factor: 22.7, order: 27 },
                    { id: '28', name: 'PAC™-L', factor: 22.7, order: 28 },
                    { id: '29', name: 'BENTONITA BOLSÓN', factor: 700, order: 29 },
                    { id: '30', name: 'BENTONITA PALLET', factor: 20, order: 30 },
                    { id: '31', name: 'SODA ASH', factor: 25, order: 31 },
                    { id: '32', name: 'SODA CÁUSTICA', factor: 25, order: 32 },
                    { id: '33', name: 'Potassium chloride (KCl)', factor: 25, order: 33 },
                    { id: '34', name: 'BARAVIS W-637', factor: 10, order: 34 },
                    { id: '35', name: 'TS PLUS YPF', factor: 11.34, order: 35 },
                    { id: '36', name: 'CALCIUM CHLORIDE BRINE (YPF)', factor: 1, order: 36 },
                    { id: '37', name: 'BARITA EN BOLSONES', factor: 1.5, order: 37 },
                    { id: '38', name: 'Cloruro de Calcio', factor: 25, order: 38 },
                    { id: '39', name: 'BARITA EN SILO', factor: 1, order: 39 },
                    { id: '40', name: 'INVERMUL®', factor: 208, order: 40 },
                    { id: '41', name: 'LE SUPERMUL™', factor: 1, order: 41 },
                    { id: '42', name: 'TAU-MOD®', factor: 22.7, order: 42 }
                ];
            });

            const getInitialEntries = () => Array.from({ length: 12 }, (_, i) => ({
                id: Date.now() + i,
                productId: '',
                physical: '',
                software: '',
                searchTerm: ''
            }));

            const [entries, setEntries] = useState(() => {
                const saved = localStorage.getItem('baroid_inventory_entries_v1');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return parsed.length > 0 ? parsed : getInitialEntries();
                }
                return getInitialEntries();
            });

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [newProduct, setNewProduct] = useState({ name: '', factor: '1', order: '' });
            const [sortConfig, setSortConfig] = useState({ key: 'custom', direction: 'asc' });

            useEffect(() => {
                localStorage.setItem('baroid_products_inventory_v2', JSON.stringify(products));
            }, [products]);

            useEffect(() => {
                localStorage.setItem('baroid_inventory_entries_v1', JSON.stringify(entries));
            }, [entries]);

            const sortedProducts = useMemo(() => [...products].sort((a, b) => (parseFloat(a.order) || 0) - (parseFloat(b.order) || 0)), [products]);

            const displayEntries = useMemo(() => {
                const sorted = [...entries].sort((a, b) => {
                    const prodA = products.find(p => p.id === a.productId);
                    const prodB = products.find(p => p.id === b.productId);

                    if (sortConfig.key === 'custom') {
                        const orderA = prodA ? (parseFloat(prodA.order) || 0) : Infinity;
                        const orderB = prodB ? (parseFloat(prodB.order) || 0) : Infinity;
                        return sortConfig.direction === 'asc' ? orderA - orderB : orderB - orderA;
                    } else if (sortConfig.key === 'name') {
                        const nameA = prodA ? prodA.name.toLowerCase() : (a.searchTerm || '').toLowerCase() || 'zzz';
                        const nameB = prodB ? prodB.name.toLowerCase() : (b.searchTerm || '').toLowerCase() || 'zzz';
                        return sortConfig.direction === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
                    }
                    return 0;
                });
                return sorted;
            }, [entries, products, sortConfig]);

            const addEntry = () => setEntries([...entries, { id: Date.now(), productId: '', physical: '', software: '', searchTerm: '' }]);

            const updateEntry = (id, field, val) => {
                setEntries(prev => prev.map(e => e.id === id ?
                    (typeof field === 'string' ? { ...e, [field]: val } : { ...e, ...field })
                    : e));
            };

            const removeEntry = (id) => {
                if (entries.length > 1) setEntries(entries.filter(e => e.id !== id));
                else setEntries(getInitialEntries().slice(0, 1));
            };

            const clearForm = () => {
                if (confirm('¿Desea limpiar todos los datos del formulario?')) {
                    setEntries(getInitialEntries());
                }
            };

            const exportPDF = () => {
                const element = document.getElementById('inventory-report-container');
                const date = new Date().toLocaleDateString();
                const opt = {
                    margin: 10,
                    filename: `Conciliacion_Inventario_${date}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };

                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) document.documentElement.classList.remove('dark');

                html2pdf().from(element).set(opt).save().then(() => {
                    if (isDark) document.documentElement.classList.add('dark');
                });
            };

            const addProduct = () => {
                setNewProduct({ name: '', factor: '1', order: products.length + 1 });
                setShowAddModal(true);
            };

            const handleSaveProduct = () => {
                if (!newProduct.name || !newProduct.factor) {
                    alert('Por favor complete el nombre y el factor.');
                    return;
                }
                setProducts([...products, {
                    id: Date.now().toString(),
                    name: newProduct.name,
                    factor: parseFloat(newProduct.factor) || 1,
                    order: parseInt(newProduct.order) || products.length + 1
                }]);
                setShowAddModal(false);
            };

            const updateProduct = (id, field, val) => setProducts(products.map(p => p.id === id ? { ...p, [field]: val } : p));
            const removeProduct = (id) => setProducts(products.filter(p => p.id !== id));

            const importCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    const newProducts = lines.slice(1).map((line, idx) => {
                        const parts = line.split(',');
                        if (parts.length < 2) return null;
                        return {
                            id: Date.now() + idx,
                            name: parts[0].trim(),
                            factor: parseFloat(parts[1]) || 1,
                            order: idx + 1
                        };
                    }).filter(p => p !== null);
                    if (newProducts.length > 0) {
                        setProducts(newProducts);
                        alert(`Se cargaron ${newProducts.length} productos.`);
                    }
                };
                reader.readAsText(file);
            };

            const downloadCSVTemplate = () => {
                const csvContent = "Producto,Factor (kg/L)\nBAROID,1.0\nGELTONE II,22.7\nRM-63,208.0\nLIME FG,20.0";
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "plantilla_inventario_baroid.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="animate-fade-in space-y-8">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div className="flex items-center gap-4">
                            <div className="p-4 bg-halliburton-red rounded-3xl shadow-lg shadow-red-900/20">
                                <Icon name="clipboard-check" size={32} className="text-white" />
                            </div>
                            <div>
                                <h3 className="text-3xl font-black uppercase italic tracking-tighter text-zinc-800 dark:text-white title-font">Panel de Inventario</h3>
                                <p className="text-[10px] font-black text-zinc-400 uppercase tracking-widest">Conciliación de Inventario ( vs Software)</p>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                                className={`flex items-center gap-2 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border ${isSettingsOpen ? 'bg-zinc-900 text-white border-zinc-900 shadow-xl' : 'bg-white dark:bg-slate-800 text-zinc-500 border-zinc-100 dark:border-zinc-700 hover:border-halliburton-red'}`}
                            >
                                <Icon name={isSettingsOpen ? "check" : "settings"} size={14} />
                                {isSettingsOpen ? 'Finalizar Configuración' : 'Configurar Productos'}
                            </button>
                        </div>
                    </div>

                    {isSettingsOpen && (
                        <div className="bg-zinc-50 dark:bg-slate-900/50 p-10 rounded-[3.5rem] border-2 border-dashed border-zinc-200 dark:border-zinc-800 animate-fade-in space-y-8">
                            <div className="flex justify-between items-center">
                                <h4 className="text-xl font-black uppercase italic text-zinc-700 dark:text-zinc-300">Maestro de Productos</h4>
                                <div className="flex gap-4">
                                    <button onClick={addProduct} className="btn-primary px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg">+ Nuevo Producto</button>
                                </div>
                            </div>
                            <div className="max-h-96 overflow-y-auto custom-scrollbar pr-4">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-zinc-50 dark:bg-slate-950 z-10">
                                        <tr className="text-[10px] font-black uppercase text-zinc-400 tracking-widest">
                                            <th className="pb-4 px-2 w-20 text-center">Orden</th>
                                            <th className="pb-4 px-2">Producto / Descripción</th>
                                            <th className="pb-4 px-2 w-48">Factor (kg/L) por UM</th>
                                            <th className="pb-4 px-2 w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-zinc-200 dark:divide-zinc-800">
                                        {products.map(p => (
                                            <tr key={p.id} className="group hover:bg-zinc-100 dark:hover:bg-slate-800/30 transition-colors">
                                                <td className="py-4 px-2 text-center">
                                                    <input type="number" value={p.order} onChange={e => updateProduct(p.id, 'order', e.target.value)} className="w-16 input-style !py-2 !px-2 text-center font-bold" />
                                                </td>
                                                <td className="py-4 px-2">
                                                    <input type="text" value={p.name} onChange={e => updateProduct(p.id, 'name', e.target.value)} className="w-full input-style !py-2 !px-4" placeholder="Nombre (Ej: GELTONE II)" />
                                                </td>
                                                <td className="py-4 px-2">
                                                    <div className="relative">
                                                        <input type="number" value={p.factor} onChange={e => updateProduct(p.id, 'factor', e.target.value)} className="w-full input-style !py-2 !px-4 font-black" placeholder="Factor" />
                                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-[9px] font-black text-zinc-400 uppercase">Kg/L</span>
                                                    </div>
                                                </td>
                                                <td className="py-4 px-2 text-right">
                                                    <button onClick={() => removeProduct(p.id)} className="p-2 text-zinc-300 hover:text-halliburton-red transition-all transform hover:scale-110">
                                                        <Icon name="trash-2" size={18} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    <div id="inventory-report-container" className="bg-white dark:bg-slate-900 rounded-[2.5rem] p-6 shadow-2xl border border-zinc-100 dark:border-zinc-800">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-separate border-spacing-y-1 min-w-[1000px]">
                                <thead>
                                    <tr className="text-[9px] font-black uppercase text-zinc-400 tracking-widest px-4">
                                        <th
                                            className="pb-2 px-4 w-1/4 cursor-pointer hover:text-halliburton-red transition-colors group"
                                            onClick={() => {
                                                if (sortConfig.key === 'name') {
                                                    setSortConfig({ key: 'name', direction: sortConfig.direction === 'asc' ? 'desc' : 'asc' });
                                                } else {
                                                    setSortConfig({ key: 'name', direction: 'asc' });
                                                }
                                            }}
                                        >
                                            <div className="flex items-center gap-2">
                                                Producto
                                                <div className={`transition-all ${sortConfig.key === 'name' ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                                                    <Icon name={sortConfig.key === 'name' ? (sortConfig.direction === 'asc' ? 'chevron-up' : 'chevron-down') : 'chevrons-up-down'} size={10} />
                                                </div>
                                            </div>
                                        </th>
                                        <th className="pb-2 px-4 text-center w-28"> (Bags - Lts - Can)</th>
                                        <th className="pb-2 px-4 text-center"> (kg/L)</th>
                                        <th className="pb-2 px-4 text-center w-48">Cantidad en WS2020 (kg/L)</th>
                                        <th className="pb-2 px-4 text-center">Dif. (kg/L)</th>
                                        <th className="pb-2 px-4 text-center">Dif. (UM)</th>
                                        <th className="pb-2 px-4 text-center w-40">Estado</th>
                                        <th
                                            className="pb-2 px-4 w-10 text-center cursor-pointer hover:text-halliburton-red transition-colors group"
                                            onClick={() => {
                                                if (sortConfig.key === 'custom') {
                                                    setSortConfig({ key: 'custom', direction: sortConfig.direction === 'asc' ? 'desc' : 'asc' });
                                                } else {
                                                    setSortConfig({ key: 'custom', direction: 'asc' });
                                                }
                                            }}
                                        >
                                            <div className="flex items-center justify-center" title="Ordenar por Orden Maestro">
                                                <Icon name={sortConfig.key === 'custom' ? (sortConfig.direction === 'asc' ? 'arrow-down-01' : 'arrow-up-10') : 'sort-asc'} size={12} className={sortConfig.key === 'custom' ? 'text-halliburton-red' : ''} />
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {displayEntries.map(e => {
                                        const prod = products.find(p => p.id === e.productId);
                                        const factor = prod ? parseFloat(prod.factor) || 0 : 0;
                                        const physUM = parseFloat(e.physical) || 0;
                                        const softWS = parseFloat(e.software) || 0;

                                        const physKgL = physUM * factor;
                                        const diffKgL = physKgL - softWS;
                                        const diffUM = factor !== 0 ? diffKgL / factor : 0;

                                        let statusKey = "OK";
                                        let bgClass = "bg-green-500/10 text-green-600 ring-green-500/30";
                                        if (diffKgL < -0.01) {
                                            statusKey = "FALTA COBRAR";
                                            bgClass = "bg-red-500/10 text-red-600 ring-red-500/30";
                                        } else if (diffKgL > 0.01) {
                                            statusKey = "CONSUMIR SIN COBRAR (AJUSTE)";
                                            bgClass = "bg-yellow-500/10 text-yellow-600 ring-yellow-500/30";
                                        }

                                        return (
                                            <tr key={e.id} className="group/row transition-all bg-zinc-50/50 dark:bg-slate-800/10 hover:bg-zinc-100 dark:hover:bg-slate-800/30">
                                                <td className="py-0.5 px-3 rounded-l-xl relative">
                                                    <div className="relative group/select">
                                                        <input
                                                            type="text"
                                                            value={prod ? prod.name : (e.searchTerm || '')}
                                                            onChange={(val) => {
                                                                const term = val.target.value;
                                                                updateEntry(e.id, 'searchTerm', term);
                                                                if (prod && term !== prod.name) {
                                                                    updateEntry(e.id, 'productId', '');
                                                                }
                                                            }}
                                                            onKeyDown={(evt) => {
                                                                if (evt.key === 'Tab' && !e.productId && (e.searchTerm || '').length > 0) {
                                                                    const filtered = sortedProducts.filter(p => p.name.toLowerCase().includes((e.searchTerm || '').toLowerCase()));
                                                                    if (filtered.length > 0) {
                                                                        const bestMatch = filtered[0];
                                                                        updateEntry(e.id, { productId: bestMatch.id, searchTerm: bestMatch.name, isDropdownOpen: false });
                                                                    }
                                                                }
                                                            }}
                                                            onFocus={() => updateEntry(e.id, 'isDropdownOpen', true)}
                                                            onBlur={() => setTimeout(() => updateEntry(e.id, 'isDropdownOpen', false), 250)}
                                                            placeholder="Buscar..."
                                                            className="w-full input-style !py-1 !px-3 font-bold pr-8 text-[11px]"
                                                        />
                                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 text-zinc-400 pointer-events-none">
                                                            <Icon name="chevron-down" size={12} />
                                                        </div>

                                                        {e.isDropdownOpen && (
                                                            <div className="absolute left-0 right-0 top-full mt-2 bg-white dark:bg-slate-900 border border-zinc-200 dark:border-zinc-800 rounded-2xl shadow-2xl z-50 max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-1">
                                                                {sortedProducts
                                                                    .filter(p => !e.searchTerm || p.name.toLowerCase().includes((e.searchTerm || '').toLowerCase()))
                                                                    .map(p => (
                                                                        <button
                                                                            key={p.id}
                                                                            onClick={() => {
                                                                                updateEntry(e.id, { productId: p.id, searchTerm: p.name, isDropdownOpen: false });
                                                                            }}
                                                                            className="w-full text-left px-5 py-3 hover:bg-halliburton-red hover:text-white transition-colors text-sm font-bold flex items-center justify-between group/item"
                                                                        >
                                                                            <span className="truncate">{p.name}</span>
                                                                            <span className="text-[9px] opacity-40 group-hover/item:opacity-100 uppercase tracking-widest">{p.factor} Kg/L</span>
                                                                        </button>
                                                                    ))
                                                                }
                                                                {sortedProducts.filter(p => !e.searchTerm || p.name.toLowerCase().includes((e.searchTerm || '').toLowerCase())).length === 0 && (
                                                                    <div className="px-5 py-4 text-xs text-zinc-400 italic">No se encontraron resultados</div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="py-0.5 px-3">
                                                    <input
                                                        type="number"
                                                        value={e.physical}
                                                        onChange={val => updateEntry(e.id, 'physical', val.target.value)}
                                                        className="w-full input-style text-center !py-1 !px-1 font-black text-[11px]"
                                                        placeholder="0"
                                                    />
                                                </td>
                                                <td className="py-0.5 px-3 text-center font-black text-zinc-500 dark:text-zinc-400 text-sm tabular-nums">
                                                    {physKgL.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })}
                                                </td>
                                                <td className="py-0.5 px-3">
                                                    <div className="relative">
                                                        <input
                                                            type="number"
                                                            value={e.software}
                                                            onChange={val => updateEntry(e.id, 'software', val.target.value)}
                                                            className="w-full input-style text-center !py-1 !px-1 font-black text-[11px]"
                                                            placeholder="Stock"
                                                        />
                                                    </div>
                                                </td>
                                                <td className={`py-0.5 px-3 text-center font-black text-lg tabular-nums ${diffKgL < -0.01 ? 'text-red-600' : (diffKgL > 0.01 ? 'text-yellow-600' : 'text-green-600')}`}>
                                                    {diffKgL === 0 ? '0' : (diffKgL > 0 ? '+' : '') + diffKgL.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })}
                                                </td>
                                                <td className="py-0.5 px-3 text-center font-bold text-xs opacity-60 tabular-nums">
                                                    {diffUM === 0 ? '-' : (diffUM > 0 ? '+' : '') + diffUM.toFixed(2)}
                                                </td>
                                                <td className="py-1 px-3">
                                                    <div className={`px-2 py-1 rounded-md text-[7px] font-black uppercase tracking-wider text-center ring-1 ring-inset ${bgClass}`}>
                                                        {statusKey}
                                                    </div>
                                                </td>
                                                <td className="py-0.5 px-3 rounded-r-xl text-center">
                                                    <button onClick={() => removeEntry(e.id)} className="p-2 text-zinc-300 dark:text-zinc-700 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all">
                                                        <Icon name="trash-2" size={14} />
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        <div className="mt-12 pt-10 border-t border-zinc-100 dark:border-zinc-800 flex flex-col md:flex-row justify-between items-center gap-8">
                            <button
                                onClick={addEntry}
                                className="flex items-center gap-3 px-8 py-4 bg-zinc-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] hover:scale-105 active:scale-95 transition-all shadow-xl"
                            >
                                <Icon name="plus" size={16} />
                                Agregar Producto al Conteo
                            </button>

                            <div className="flex items-center gap-3">
                                <button onClick={clearForm} className="px-8 py-4 bg-zinc-100 dark:bg-slate-800 text-zinc-500 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] hover:bg-zinc-200 dark:hover:bg-slate-700 transition-all">
                                    <Icon name="refresh-ccw" size={14} className="inline mr-2" />
                                    Limpiar Todo
                                </button>
                            </div>
                        </div>
                    </div>

                    {showImportModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 animate-fade-in">
                            <div className="absolute inset-0 bg-zinc-900/60 backdrop-blur-sm" onClick={() => setShowImportModal(false)}></div>
                            <div className="relative bg-white dark:bg-slate-900 w-full max-w-xl rounded-[3rem] shadow-2xl border border-white/20 p-10 space-y-8 animate-modal-in overflow-hidden">
                                <div className="absolute top-0 right-0 p-8">
                                    <button onClick={() => setShowImportModal(false)} className="text-zinc-400 hover:text-halliburton-red transition-colors">
                                        <Icon name="x" size={24} />
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    <h3 className="text-3xl font-black uppercase italic tracking-tighter text-zinc-800 dark:text-white title-font">Importar Base de Datos</h3>
                                    <p className="text-[10px] font-black text-zinc-400 uppercase tracking-widest">Carga masiva de productos vía CSV</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <button
                                        onClick={downloadCSVTemplate}
                                        className="flex flex-col items-center justify-center p-8 bg-zinc-50 dark:bg-slate-800/50 rounded-[2rem] border-2 border-dashed border-zinc-200 dark:border-zinc-800 hover:border-halliburton-red group transition-all"
                                    >
                                        <div className="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg mb-4 group-hover:scale-110 transition-transform">
                                            <Icon name="download" size={24} className="text-halliburton-red" />
                                        </div>
                                        <span className="text-[10px] font-black uppercase tracking-widest text-zinc-600 dark:text-zinc-300">Descargar Plantilla Madre</span>
                                        <span className="text-[8px] font-bold text-zinc-400 mt-2 uppercase tracking-tight text-center">Para saber cómo cargar los datos</span>
                                    </button>

                                    <label className="flex flex-col items-center justify-center p-8 bg-zinc-50 dark:bg-slate-800/50 rounded-[2rem] border-2 border-dashed border-zinc-200 dark:border-zinc-800 hover:border-halliburton-red group cursor-pointer transition-all">
                                        <input type="file" accept=".csv" className="hidden" onChange={(e) => { importCSV(e); setShowImportModal(false); }} />
                                        <div className="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg mb-4 group-hover:scale-110 transition-transform">
                                            <Icon name="upload" size={24} className="text-halliburton-red" />
                                        </div>
                                        <span className="text-[10px] font-black uppercase tracking-widest text-zinc-600 dark:text-zinc-300">Adjuntar Archivo CSV</span>
                                        <span className="text-[8px] font-bold text-zinc-400 mt-2 uppercase tracking-tight text-center">Seleccionar archivo de tu equipo</span>
                                    </label>
                                </div>

                                <div className="p-6 bg-red-50 dark:bg-red-900/10 rounded-2xl border border-red-100 dark:border-red-900/20">
                                    <p className="text-[9px] font-bold text-red-600 dark:text-red-400 leading-relaxed uppercase">
                                        <Icon name="alert-circle" size={10} className="inline mr-1 mb-0.5" />
                                        Nota: La importación reemplazará todos los productos actuales en la base de datos.
                                    </p>
                                    <div className="mt-3 flex gap-4 text-[8px] font-mono text-zinc-400 dark:text-zinc-500 bg-white/50 dark:bg-black/20 p-2 rounded-lg">
                                        <span>Ejemplo:</span>
                                        <span>Producto,Factor(kg/L)</span>
                                        <span>BAROID,1.0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 animate-fade-in">
                            <div className="absolute inset-0 bg-zinc-900/60 backdrop-blur-sm" onClick={() => setShowAddModal(false)}></div>
                            <div className="relative bg-white dark:bg-slate-900 w-full max-w-lg rounded-[3rem] shadow-2xl border border-white/20 p-10 space-y-8 animate-modal-in">
                                <div className="space-y-2 text-center">
                                    <h3 className="text-3xl font-black uppercase italic tracking-tighter text-zinc-800 dark:text-white title-font">Nuevo Producto</h3>
                                    <p className="text-[10px] font-black text-zinc-400 uppercase tracking-widest">Añadir producto maestro al sistema</p>
                                </div>

                                <div className="space-y-6">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase text-zinc-400 tracking-widest px-1">Nombre del Producto</label>
                                        <input
                                            type="text"
                                            value={newProduct.name}
                                            onChange={e => setNewProduct({ ...newProduct, name: e.target.value })}
                                            className="w-full input-style !py-4 !px-6 text-lg font-bold"
                                            placeholder="Ej: GELTONE II"
                                            autoFocus
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="space-y-2">
                                            <label className="text-[10px] font-black uppercase text-zinc-400 tracking-widest px-1">Factor (kg/L)</label>
                                            <div className="relative">
                                                <input
                                                    type="number"
                                                    value={newProduct.factor}
                                                    onChange={e => setNewProduct({ ...newProduct, factor: e.target.value })}
                                                    className="w-full input-style !py-4 !px-6 text-lg font-black"
                                                    placeholder="1.0"
                                                />
                                                <span className="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-zinc-400">KG/L</span>
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-[10px] font-black uppercase text-zinc-400 tracking-widest px-1">Nº Orden</label>
                                            <input
                                                type="number"
                                                value={newProduct.order}
                                                onChange={e => setNewProduct({ ...newProduct, order: e.target.value })}
                                                className="w-full input-style !py-4 !px-6 text-lg font-bold text-center"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 pt-4">
                                    <button
                                        onClick={() => setShowAddModal(false)}
                                        className="flex-1 px-8 py-5 bg-zinc-100 dark:bg-slate-800 text-zinc-500 rounded-3xl text-[10px] font-black uppercase tracking-[0.2em] hover:bg-zinc-200 transition-all"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={handleSaveProduct}
                                        className="flex-1 px-8 py-5 btn-primary rounded-3xl text-[10px] font-black uppercase tracking-[0.2em] shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all"
                                    >
                                        Guardar Producto
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };



        const Sidebar = ({ sectors, setActiveSector, activeSector, searchQuery, setSearchQuery, isEditing, setIsEditing, darkMode, setDarkMode, resetToDefaults, exportData, importData, fileInputRef, searchInputRef, notes, setNotes, favorites, deleteItem, setShowModal, setModalData, cardSize, setCardSize }) => (
            <aside className="w-80 sidebar-bg h-screen flex flex-col sticky top-0 z-50 overflow-hidden shrink-0">
                <div className="p-10 flex items-center gap-4">
                    <div className="w-12 h-12 bg-halliburton-red rounded-2xl flex items-center justify-center shadow-lg shadow-red-900/30">
                        <Icon name="activity" size={24} className="text-white" />
                    </div>
                    <div className="overflow-hidden">
                        <h1 className="text-xl font-black tracking-tighter text-halliburton-dark dark:text-white uppercase italic truncate">Baroid Hub</h1>
                        <span className="text-[9px] font-bold text-halliburton-red uppercase tracking-[0.3em] truncate block">Field Operations</span>
                    </div>
                </div>

                <div className="px-6 mb-8 group">
                    <div className="relative">
                        <input
                            ref={searchInputRef}
                            type="text"
                            placeholder="Buscar herramienta... (/)"
                            className="w-full bg-zinc-50 dark:bg-slate-900 border-2 border-zinc-100 dark:border-zinc-800 rounded-2xl py-4 pl-12 pr-4 text-xs font-black uppercase tracking-widest placeholder-zinc-400 focus:border-halliburton-red outline-none transition-all shadow-sm group-hover:shadow-md"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                        <Icon name="search" size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400 group-focus-within:text-halliburton-red transition-colors" />
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto custom-scrollbar px-4 space-y-1 pb-10">
                    <button onClick={() => { setActiveSector('favorites'); setSearchQuery(''); }} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm font-semibold transition-all hover:bg-zinc-50 dark:hover:bg-slate-800/50 ${activeSector === 'favorites' && !searchQuery ? 'sidebar-item-active shadow-lg' : 'text-zinc-600 dark:text-zinc-400'}`}>
                        <Icon name="heart" size={18} />
                        <span className="truncate">Mis Favoritos</span>
                        {favorites.length > 0 && <span className="ml-auto bg-zinc-100 dark:bg-slate-800 text-[10px] px-2 py-0.5 rounded-full font-black">{favorites.length}</span>}
                    </button>

                    <div className="my-6 px-4">
                        <span className="text-[10px] font-black text-zinc-400 uppercase tracking-[0.2em]">Cálculos & Operaciones</span>
                    </div>

                    <button onClick={() => { setActiveSector('calculator'); setSearchQuery(''); }} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm font-semibold transition-all hover:bg-zinc-50 dark:hover:bg-slate-800/50 ${activeSector === 'calculator' && !searchQuery ? 'sidebar-item-active shadow-lg' : 'text-zinc-600 dark:text-zinc-400'}`}>
                        <Icon name="calculator" size={18} />
                        <span className="truncate">Calculadora Fluidos</span>
                    </button>

                    <button onClick={() => { setActiveSector('inventory'); setSearchQuery(''); }} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm font-semibold transition-all hover:bg-zinc-50 dark:hover:bg-slate-800/50 ${activeSector === 'inventory' && !searchQuery ? 'sidebar-item-active shadow-lg' : 'text-zinc-600 dark:text-zinc-400'}`}>
                        <Icon name="clipboard-check" size={18} />
                        <span className="truncate">Conciliación Inventario</span>
                    </button>

                    <button onClick={() => { setActiveSector('piletas'); setSearchQuery(''); }} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm font-semibold transition-all hover:bg-zinc-50 dark:hover:bg-slate-800/50 ${activeSector === 'piletas' && !searchQuery ? 'sidebar-item-active shadow-lg' : 'text-zinc-600 dark:text-zinc-400'}`}>
                        <Icon name="layout" size={18} />
                        <span className="truncate">Sistema de Piletas</span>
                    </button>
                    <div className="h-[1px] bg-zinc-100 dark:bg-zinc-800 my-4 mx-4"></div>
                    <p className="text-[10px] text-zinc-400 font-black uppercase tracking-[0.2em] ml-4 mb-2">SECTORES</p>
                    {sectors.map(sec => (
                        <div key={sec.id} className="group relative">
                            <button onClick={() => { setActiveSector(sec.id); setSearchQuery(''); }} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl text-sm font-semibold transition-all hover:bg-zinc-50 dark:hover:bg-slate-800/50 ${activeSector === sec.id && !searchQuery ? 'sidebar-item-active' : 'text-zinc-600 dark:text-zinc-400'}`}>
                                <Icon name={sec.icon} size={18} style={{ color: (activeSector === sec.id && !searchQuery) ? '#CC0000' : '#8E979D' }} />
                                <span className="truncate">{sec.name}</span>
                            </button>
                            {isEditing && (
                                <div className="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1 opacity-0 group-hover:opacity-100 scale-90">
                                    <button onClick={() => { setModalData({ type: 'sector', id: sec.id, name: sec.name, icon: sec.icon }); setShowModal('edit-item'); }} className="p-2 text-zinc-400 hover:text-halliburton-red transition-colors"><Icon name="edit-2" size={14} /></button>
                                    <button onClick={() => deleteItem('sector', sec.id)} className="p-2 text-zinc-400 hover:text-halliburton-red transition-colors"><Icon name="trash-2" size={14} /></button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                <div className="p-6 border-t border-zinc-100 dark:border-zinc-800 space-y-3 bg-white dark:bg-transparent">
                    <button onClick={() => setIsEditing(!isEditing)} className={`w-full flex items-center justify-center gap-2 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${isEditing ? 'bg-halliburton-red text-white' : 'bg-zinc-100 dark:bg-slate-800 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-slate-700'}`}>
                        <Icon name={isEditing ? "check" : "settings"} size={14} /> {isEditing ? "Finalizar" : "Gestionar App"}
                    </button>
                    {isEditing && (
                        <>
                            <button onClick={exportData} className="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest bg-zinc-50 dark:bg-slate-800/50 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-slate-700 border border-zinc-200 dark:border-zinc-800">
                                <Icon name="download" size={12} /> Descargar Back Up
                            </button>
                            <button onClick={() => fileInputRef.current?.click()} className="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest bg-zinc-50 dark:bg-slate-800/50 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-slate-700 border border-zinc-200 dark:border-zinc-800">
                                <Icon name="upload" size={12} /> Importar Back Up
                            </button>
                            <input type="file" ref={fileInputRef} onChange={importData} accept=".json" className="hidden" />
                            <button onClick={resetToDefaults} className="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest bg-zinc-50 dark:bg-slate-800/50 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 border border-red-100 dark:border-red-900/30">
                                <Icon name="rotate-ccw" size={12} /> Restablecer Original
                            </button>
                        </>
                    )}
                </div>
            </aside>
        );

        const MainContent = ({ displaySectors, activeSector, searchQuery, sectors, isEditing, setShowModal, setModalData, deleteItem, trackLinkClick, toggleFavorite, cardSize, setCardSize, darkMode, setDarkMode }) => (
            <main className="flex-1 min-h-screen p-12 overflow-x-hidden relative">
                {/* Top Controls Overlay */}
                <div className="absolute top-8 right-12 z-40 flex items-center gap-4">
                    <div className="flex bg-white/80 dark:bg-slate-900/80 backdrop-blur-md p-1.5 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-xl">
                        <button
                            onClick={() => setCardSize('large')}
                            className={`p-2.5 rounded-xl transition-all ${cardSize === 'large' ? 'bg-halliburton-red text-white shadow-lg' : 'text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300'}`}
                            title="Vista Grande"
                        >
                            <Icon name="layout-grid" size={20} />
                        </button>
                        <button
                            onClick={() => setCardSize('small')}
                            className={`p-2.5 rounded-xl transition-all ${cardSize === 'small' ? 'bg-halliburton-red text-white shadow-lg' : 'text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300'}`}
                            title="Vista Compacta"
                        >
                            <Icon name="grid-3x3" size={20} />
                        </button>
                    </div>
                    <button
                        onClick={() => setDarkMode(!darkMode)}
                        className="p-3.5 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-xl text-zinc-500 dark:text-zinc-400 hover:scale-105 transition-all"
                        title={darkMode ? "Modo Claro" : "Modo Oscuro"}
                    >
                        <Icon name={darkMode ? "sun" : "moon"} size={22} />
                    </button>
                </div>

                <div className={cardSize === 'small' ? "max-w-[1400px] mx-auto" : "max-w-6xl mx-auto"}>
                    <header className="mb-14">
                        {(!searchQuery && activeSector !== 'favorites' && activeSector !== 'calculator' && activeSector !== 'inventory' && activeSector !== 'piletas') && <GreetingDashboard />}
                        <div className="space-y-4">
                            <div className="flex items-center gap-3">
                                <div className="w-1.5 h-6 bg-halliburton-red rounded-full"></div>
                                <span className="text-[12px] font-bold text-halliburton-red uppercase tracking-widest">
                                    {activeSector === 'favorites' ? 'Acceso Rápido' : (activeSector === 'calculator' ? 'Ingeniería' : (activeSector === 'inventory' ? 'Auditoría' : (activeSector === 'piletas' ? 'Volumen Activo' : (sectors.find(s => s.id === activeSector)?.name || 'Explorar'))))}
                                </span>
                            </div>
                            <h2 className="text-5xl font-black uppercase italic leading-none tracking-tighter text-halliburton-dark dark:text-white truncate">
                                {activeSector === 'favorites' ? 'Mis Favoritos' : (activeSector === 'calculator' ? 'Calculadora de Fluidos' : (activeSector === 'inventory' ? 'Conciliación de Inventario' : (activeSector === 'piletas' ? 'Sistema de Piletas' : (sectors.find(s => s.id === activeSector)?.name || 'Directorio'))))}
                            </h2>
                        </div>
                    </header>
                    <div className="space-y-20">
                        {activeSector === 'calculator' ? <FluidCalculator isEditing={isEditing} /> :
                            activeSector === 'inventory' ? <InventoryConciliation isEditing={isEditing} /> :
                                activeSector === 'piletas' ? <PiletasSystem isEditing={isEditing} /> :
                                    displaySectors.map(sec => (
                                        <div key={sec.id} className="space-y-10 animate-fade-in">
                                            {sec.id === 'sec_pdf' && (
                                                <div className="bg-halliburton-red/5 dark:bg-red-900/10 border-2 border-dashed border-halliburton-red/30 rounded-[3rem] p-12 text-center group/upload hover:border-halliburton-red/60 transition-all">
                                                    <div className="max-w-md mx-auto">
                                                        <div className="w-16 h-16 bg-halliburton-red rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl group-hover/upload:scale-110 transition-transform">
                                                            <Icon name="upload-cloud" size={32} className="text-white" />
                                                        </div>
                                                        <h3 className="text-xl font-black uppercase italic text-zinc-800 dark:text-white mb-2">Subir Nuevo Documento PDF</h3>
                                                        <p className="text-xs font-bold text-zinc-400 uppercase tracking-widest mb-8">El archivo se guardará localmente en tu navegador</p>
                                                        <input
                                                            type="file"
                                                            accept=".pdf"
                                                            id="pdf-upload"
                                                            className="hidden"
                                                            onChange={(e) => {
                                                                const file = e.target.files[0];
                                                                if (!file) return;
                                                                if (file.size > 2 * 1024 * 1024) {
                                                                    alert('El archivo es muy pesado (máximo 2MB para almacenamiento local)');
                                                                    return;
                                                                }
                                                                const reader = new FileReader();
                                                                reader.onload = (event) => {
                                                                    trackLinkClick('pdf_upload');
                                                                    // Determinamos el subsector de usuario
                                                                    const sec_pdf = sectors.find(s => s.id === 'sec_pdf');
                                                                    if (sec_pdf && sec_pdf.subsectors.length > 0) {
                                                                        // Usamos la función addLink que pasaremos por props
                                                                        window.baroidAddPdf(sec_pdf.id, sec_pdf.subsectors[0].id, file.name.replace('.pdf', ''), event.target.result);
                                                                    }
                                                                };
                                                                reader.readAsDataURL(file);
                                                            }}
                                                        />
                                                        <label htmlFor="pdf-upload" className="inline-block px-10 py-5 bg-halliburton-red text-white text-[10px] font-black uppercase tracking-[0.2em] rounded-2xl cursor-pointer shadow-xl hover:bg-zinc-800 transition-all hover:scale-105 active:scale-95">
                                                            Seleccionar Archivo
                                                        </label>
                                                    </div>
                                                </div>
                                            )}
                                            {sec.subsectors.map(sub => (
                                                <section key={sub.id} className="group/sub">
                                                    <div className="flex items-center justify-between mb-8 border-b-2 border-zinc-100 dark:border-zinc-800 pb-4">
                                                        <h3 className="text-2xl font-extrabold text-zinc-800 dark:text-zinc-200 uppercase italic flex items-center gap-3 tracking-tight">
                                                            {sub.name}
                                                        </h3>
                                                        {isEditing && activeSector !== 'favorites' && (
                                                            <div className="flex gap-2">
                                                                <button onClick={() => { setModalData({ type: 'subsector', id: sub.id, name: sub.name }); setShowModal('edit-item'); }} className="p-2 text-zinc-400 hover:text-halliburton-red transition-colors"><Icon name="edit-2" size={16} /></button>
                                                                <button onClick={() => { setModalData({ sid: sec.id, subsid: sub.id }); setShowModal('add-link'); }} className="px-4 py-2 btn-primary text-[10px] font-extrabold uppercase rounded-lg shadow-sm">+ Nuevo Link</button>
                                                                <button onClick={() => deleteItem('subsector', sec.id, sub.id)} className="p-2 text-zinc-400 hover:text-halliburton-red transition-colors"><Icon name="trash-2" size={16} /></button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    {sub.layout === 'list' ? (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                                            {sub.links.map((l, lIdx) => (
                                                                <div key={l.id} className="relative group/list-item card-entrance" style={{ animationDelay: `${lIdx * 0.05}s` }}>
                                                                    <a
                                                                        href={l.url}
                                                                        target="_blank"
                                                                        onClick={() => trackLinkClick(l.id)}
                                                                        className="flex items-center gap-4 bg-white dark:bg-slate-800/20 border border-zinc-100 dark:border-zinc-800 p-4 rounded-2xl hover:bg-zinc-50 dark:hover:bg-slate-800/40 transition-all group-hover/list-item:border-halliburton-red/30"
                                                                    >
                                                                        <div className="bg-zinc-50 dark:bg-slate-900 p-2.5 rounded-xl group-hover/list-item:bg-red-50 dark:group-hover/list-item:bg-red-900/20 transition-colors">
                                                                            <Icon name="video" size={16} className="text-halliburton-red" />
                                                                        </div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <h4 className="text-[14px] font-bold text-zinc-700 dark:text-zinc-300 truncate tracking-tight">{l.name}</h4>
                                                                            <p className="text-[9px] text-zinc-400 font-black uppercase tracking-widest truncate">{getDisplayUrl(l.url)}</p>
                                                                        </div>
                                                                        <Icon name="external-link" size={14} className="text-zinc-300 dark:text-zinc-700 group-hover/list-item:text-halliburton-red transition-all transform translate-x-2 opacity-0 group-hover/list-item:translate-x-0 group-hover/list-item:opacity-100" />
                                                                    </a>
                                                                    {isEditing && (
                                                                        <div className="absolute -top-2 -right-2 flex gap-1 z-10 scale-75 opacity-0 group-hover/list-item:opacity-100 transition-opacity">
                                                                            <button onClick={() => { setModalData({ type: 'link', id: l.id, name: l.name, url: l.url }); setShowModal('edit-item'); }} className="bg-white dark:bg-slate-800 p-2 rounded-full text-zinc-400 hover:text-halliburton-red shadow-lg border border-zinc-100 dark:border-zinc-800"><Icon name="edit-3" size={12} /></button>
                                                                            <button onClick={() => deleteItem('link', sec.id, sub.id, l.id)} className="bg-halliburton-red p-2 rounded-full text-white shadow-lg"><Icon name="x" size={12} /></button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className={cardSize === 'small'
                                                            ? "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5"
                                                            : "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
                                                        }>
                                                            {sub.links.map((l, lIdx) => (
                                                                <div key={l.id} className="relative group/card card-entrance" style={{ animationDelay: `${lIdx * 0.1}s` }}>
                                                                    <a href={l.url} target="_blank" onClick={() => trackLinkClick(l.id)} className={`block bg-white dark:bg-slate-800/40 border border-zinc-100 dark:border-zinc-800 card-shadow hover-glow h-full overflow-hidden relative ${cardSize === 'small' ? 'p-5 rounded-3xl' : 'p-8 rounded-[2.5rem]'}`}>
                                                                        <div className={`flex items-center justify-between ${cardSize === 'small' ? 'mb-4' : 'mb-6'}`}>
                                                                            <div className={`bg-zinc-50 dark:bg-slate-900 group-hover/card:bg-red-50 dark:group-hover/card:bg-red-900/20 transition-all duration-500 group-hover/card:rotate-[5deg] ${cardSize === 'small' ? 'p-3 rounded-xl' : 'p-4 rounded-2xl'}`}>
                                                                                <Icon name="file-text" size={24} className="text-halliburton-red" />
                                                                            </div>
                                                                            <div className="flex gap-2 items-center">
                                                                                {l.lastUsed && <span className="text-[9px] font-extrabold text-halliburton-red bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded-md uppercase italic animate-pulse">Reciente</span>}
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.preventDefault();
                                                                                        e.stopPropagation();
                                                                                        toggleFavorite(l.id);
                                                                                        const btn = e.currentTarget;
                                                                                        btn.classList.add('animate-heart-pop');
                                                                                        setTimeout(() => btn.classList.remove('animate-heart-pop'), 500);
                                                                                    }}
                                                                                    className="p-2 text-zinc-300 dark:text-zinc-700 hover:scale-125 transition-all duration-300 active:scale-95"
                                                                                >
                                                                                    <Icon name="heart" size={22} className={l.isFavorite ? "favorite-active fill-current" : "group-hover/card:text-zinc-400"} />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <h4 className="text-[17px] font-extrabold text-zinc-800 dark:text-zinc-200 uppercase leading-tight line-clamp-2 title-font tracking-tight group-hover/card:text-halliburton-red transition-colors duration-300" style={{ marginBottom: cardSize === 'small' ? '1rem' : '1.25rem' }}>{l.name}</h4>
                                                                        <div className="flex items-center justify-between mt-auto pt-4 border-t border-zinc-50 dark:border-zinc-800/50">
                                                                            <span className="text-[9px] text-zinc-400 dark:text-zinc-500 font-black uppercase tracking-[0.1em] truncate mr-2" title={getDisplayUrl(l.url)}>{getDisplayUrl(l.url)}</span>
                                                                            <div className="flex items-center gap-1 text-halliburton-red opacity-0 group-hover/card:opacity-100 transform translate-x-4 group-hover/card:translate-x-0 transition-all duration-500 shrink-0">
                                                                                <span className="text-[9px] font-black uppercase">Abrir</span>
                                                                                <Icon name="arrow-right" size={14} />
                                                                            </div>
                                                                        </div>
                                                                    </a>
                                                                    {isEditing && (
                                                                        <div className="absolute -top-3 -right-3 flex gap-2 z-10 scale-90">
                                                                            <button onClick={() => { setModalData({ type: 'link', id: l.id, name: l.name, url: l.url }); setShowModal('edit-item'); }} className="bg-white dark:bg-slate-800 p-3 rounded-full text-zinc-400 hover:text-halliburton-red shadow-lg border border-zinc-100 dark:border-zinc-800"><Icon name="edit-3" size={14} /></button>
                                                                            <button onClick={() => deleteItem('link', sec.id, sub.id, l.id)} className="bg-halliburton-red p-3 rounded-full text-white shadow-lg"><Icon name="x" size={14} /></button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </section>
                                            ))}
                                        </div>
                                    ))}
                    </div>
                </div>
                <div className="mt-20 pb-8 flex justify-center items-center gap-2 opacity-30 hover:opacity-100 transition-opacity">
                    <div className="w-8 h-[1px] bg-zinc-400"></div>
                    <span className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">creada por Ing. Rinaudo Xavier</span>
                    <div className="w-8 h-[1px] bg-zinc-400"></div>
                </div>
            </main>
        );

        const Modal = ({ showModal, setShowModal, modalData, addSector, addSubsector, addLink, updateItem }) => {
            if (!showModal) return null;
            const [form, setForm] = useState({ name: modalData.name || '', url: modalData.url || '', icon: modalData.icon || 'folder' });
            const submit = (e) => {
                e.preventDefault();
                if (showModal === 'add-sector') addSector(form.name, form.icon);
                if (showModal === 'add-subsector') addSubsector(modalData.sid, form.name);
                if (showModal === 'add-link') addLink(modalData.sid, modalData.subsid, form.name, form.url);
                if (showModal === 'edit-item') updateItem(modalData.type, modalData.id, form.name, form.url, form.icon);
            };
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-fade-in text-left">
                    <div className="bg-white dark:bg-slate-900 w-full max-w-lg p-12 rounded-[3.5rem] shadow-2xl relative border border-zinc-100 dark:border-zinc-800">
                        <button onClick={() => setShowModal(null)} className="absolute top-10 right-10 text-zinc-400 hover:text-halliburton-red transition-colors"><Icon name="x" size={28} /></button>
                        <h3 className="text-3xl font-black text-zinc-800 dark:text-white uppercase italic mb-10 tracking-tighter">Gestionar Elemento</h3>
                        <form onSubmit={submit} className="space-y-8">
                            <div>
                                <label className="text-[10px] font-black text-halliburton-red uppercase tracking-widest mb-3 block">Nombre</label>
                                <input type="text" required className="w-full input-style" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} />
                            </div>
                            {(showModal === 'add-link' || (showModal === 'edit-item' && modalData.type === 'link')) && (
                                <div>
                                    <label className="text-[10px] font-black text-halliburton-red uppercase tracking-widest mb-3 block italic">URL</label>
                                    <input type="url" required className="w-full input-style" value={form.url} onChange={e => setForm({ ...form, url: e.target.value })} />
                                </div>
                            )}
                            <button type="submit" className="w-full btn-primary py-5 rounded-3xl font-black uppercase text-xs tracking-widest shadow-xl">Guardar Cambios</button>
                        </form>
                    </div>
                </div>
            );
        };

        const INITIAL_DATA_REFINED = [
            {
                "id": "sec_hr",
                "name": "Gestión Personal & HR",
                "icon": "users",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_hr_1",
                        "name": "Sistemas Corporativos",
                        "links": [
                            {
                                "id": "l_hr_1",
                                "name": "SuccessFactors: Home",
                                "url": "https://performancemanager4.successfactors.com/sf/home?bplte_company=HALprod",
                                "lastUsed": 1768761658248,
                                "isFavorite": false
                            },
                            {
                                "id": "l_hr_2",
                                "name": "Recibo de Sueldo (Firma Digital)",
                                "url": "https://argentinapayslip.halliburton.com/firma-digital/mypaychecks",
                                "lastUsed": 1768761660895,
                                "isFavorite": false
                            },
                            {
                                "id": "l_hr_3",
                                "name": "Learning Central",
                                "url": "https://halliburton.plateau.com/learning/user/deeplink.do?fromSF=Y&linkId=HOME_PAGE",
                                "isFavorite": false
                            },
                            {
                                "id": "l_hr_4",
                                "name": "Control Horario | Panel de Usuario",
                                "url": "https://controlhorario.satelitech.com/dashboard",
                                "lastUsed": 1768763461464,
                                "isFavorite": false
                            },
                            {
                                "id": "l_hr_jm",
                                "name": "JM - Journey Management",
                                "url": "https://nam10.safelinks.protection.outlook.com/?url=https%3A%2F%2Fapps.powerapps.com%2Fplay%2Fe%2Fdefault-b7be7686-6f97-4db7-9081-a23cf09a96b5%2Fa%2F82ec6e72-c321-4275-9a9d-ea7e904f8b33%3FtenantId%3Db7be7686-6f97-4db7-9081-a23cf09a96b5%26hint%3Dc20bd8a5-1cd7-4bcd-b551-da17e7d225dc%26sourcetime%3D1694715734051%26source%3Dportal&data=05%7C02%7CXavierCustodio.Rinaudo2%40halliburton.com%7Ce40092f404c74d5cf78e08ddbe38fdc5%7Cb7be76866f974db79081a23cf09a96b5%7C0%7C0%7C638875874177981292%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=DTRtJKuupPDy2%2Bm%2BFny8fJ8vlBTFTz7f6kRUe4ivMqM%3D&reserved=0",
                                "isFavorite": false
                            }
                        ]
                    }
                ]
            },
            {
                "id": "sec_safety",
                "name": "HSE - Gestión de Riesgos",
                "icon": "shield-check",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_saf_1",
                        "name": "Portales & Sistemas",
                        "links": [
                            {
                                "id": "l_saf_1",
                                "name": "Halworld",
                                "url": "https://halworld.corp.halliburton.com/en/support-services/hsesq.html",
                                "lastUsed": 1768760807677
                            },
                            {
                                "id": "l_saf_2",
                                "name": "APPIAN: RA y JSA",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment"
                            },
                            {
                                "id": "l_saf_4",
                                "name": "One View: Observaciones",
                                "url": "https://halliburton-az.us.enablon.io/HALOneView/go.aspx"
                            }
                        ]
                    },
                    {
                        "id": "sub_saf_2",
                        "name": "Estándares & Formatos",
                        "links": [
                            {
                                "id": "l_saf_5",
                                "name": "Estándar Global JSA y RA",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0056573",
                                "lastUsed": 1768762540700,
                                "isFavorite": false
                            },
                            {
                                "id": "l_saf_6",
                                "name": "JSA Excel Español",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=d95b1b3c47adce58b1fe8ed8536d4306&id=kb_article_view",
                                "lastUsed": 1768761337631
                            },
                            {
                                "id": "l_saf_minuta",
                                "name": "Minuta de Reunión Diaria",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=1e0dc12287eb6d90cb6eca29cebb358b&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=95e544d22be676d87b31f161fe91bf55"
                            }
                        ]
                    },
                    {
                        "id": "sub_saf_3",
                        "name": "RA Core - Actividades de Campo",
                        "links": [
                            {
                                "id": "l_saf_7",
                                "name": "RA-01860 - Servicios de Fluidos en Pozo",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lUBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf54pn6j5HKogpJ--GA9XYF0sL4us77rYOk6/view/summary"
                            },
                            {
                                "id": "l_saf_8",
                                "name": "RA-13333 - Carga y descarga de materiales",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lYBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf5zo31DI7dHnSQv7hUNUUEh1kZVkuHWKp_LfQ/view/summary"
                            },
                            {
                                "id": "l_saf_9",
                                "name": "RA-13337 - Ensayo completo OBM RIG",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lYBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf5zo31HI9CJiGjLaMv2HsC7Fwat6RmeZqHmrQ/view/summary"
                            },
                            {
                                "id": "l_saf_10",
                                "name": "RA-17189 - Ensayo completo WBM RIG",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lYBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf53oXZJI5QVwgcWwY0GrfnZzOSYIO0Az-epUw/view/summary"
                            },
                            {
                                "id": "l_saf_11",
                                "name": "RA-17196 - Monitoreo de piletas en RIG",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lYBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf53oXdGI1BdGRHLK5PqzFri-JiGJAFAym_N-w/view/summary",
                                "lastUsed": 1768760816646
                            },
                            {
                                "id": "l_saf_12",
                                "name": "RA-17187 - Operaciones en piletas",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lYBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf53oXZHI74ImA4fnD5pH4kaV8nzP5mnwLXNYg/view/summary"
                            },
                            {
                                "id": "l_saf_13",
                                "name": "RA-13329 - Acondicionamiento de Productos Químicos",
                                "url": "https://halliburtoncompany.appiancloud.com/suite/sites/risk-assessment/page/home/record/lYBA347YwPz5KHDLYTk5f6mdA-h_yslcVbCegekS2_nZqLs4MV_hVtEQTRAcoeb0kdTbiWTCWa-Ji_0mf5zo3xJI3nb1PKlGsUacoW278996Q2fnMhOLQ/view/summary"
                            }
                        ]
                    }
                ]
            },
            {
                "id": "sec_lab",
                "name": "Laboratorio & Calibraciones",
                "icon": "flask-conical",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_lab_1",
                        "name": "Plan & Master List",
                        "links": [
                            {
                                "id": "l_lab_1",
                                "name": "Master Equipment List",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0047249"
                            },
                            {
                                "id": "l_lab_2",
                                "name": "Plan de Calibración Anual",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0032730"
                            }
                        ]
                    },
                    {
                        "id": "sub_lab_cal",
                        "name": "Formularios Calibración (Verificación)",
                        "links": [
                            {
                                "id": "v_1",
                                "name": "Balanza de Fluidos",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0046980"
                            },
                            {
                                "id": "v_2",
                                "name": "ES Meter - Estabilidad Eléctrica",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0046983"
                            },
                            {
                                "id": "v_8",
                                "name": "Medidor de pH",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0046989"
                            },
                            {
                                "id": "v_hpht",
                                "name": "HPHT Inspección de Celda",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0047009&sys_kb_id=d1d146fe874ca6946efd2fc6cebb3584&spa=1"
                            },
                            {
                                "id": "v_fann",
                                "name": "Viscosímetro FANN",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0046997&sys_kb_id=8606a55e87542290cb6eca29cebb35b2&spa=1"
                            },
                            {
                                "id": "v_eschip",
                                "name": "ES Meter Chip",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0047654&sys_kb_id=b984c3161ba4861007872fc42a4bcbc3&spa=1"
                            }
                        ]
                    },
                    {
                        "id": "sub_lab_videos",
                        "name": "Videos de Ensayos de Laboratorio",
                        "layout": "list",
                        "links": [
                            { "id": "v_vid_1", "name": "Whole Drilling Fluid Chloride", "url": "https://www.halliburton.tv/media/Whole+Drilling+Fluid+Chloride/1_6gtaxq78/103763052" },
                            { "id": "v_vid_2", "name": "How to design a Wellbore Clean-up", "url": "https://www.halliburton.tv/media/How+to+design+a+Wellbore+Clean-up/1_ajwrom7f/103763052" },
                            { "id": "v_vid_3", "name": "Lost Circulation Material (LCM) Decision Trees", "url": "https://www.halliburton.tv/media/Lost+Circulation+Material+%28LCM%29+Decision+Trees+2015-12-01+07.30/1_r71u5fvn/103763052" },
                            { "id": "v_vid_4", "name": "Whole Drilling Fluid Calcium", "url": "https://www.halliburton.tv/media/Whole+Drilling+Fluid+Calcium/1_op5jddt2/103763052" },
                            { "id": "v_vid_5", "name": "Whole Drilling Fluid Alkalinity", "url": "https://www.halliburton.tv/media/Whole+Drilling+Fluid+Alkalinity/1_at76kr3l/103763052" },
                            { "id": "v_vid_6", "name": "Baseline Alkalinity Demand (BAD)", "url": "https://www.halliburton.tv/media/Baseline+Alkalinity+Demand+%28BAD%29/1_cjdscojc/103763052" },
                            { "id": "v_vid_7", "name": "Mud Alkalinity", "url": "https://www.halliburton.tv/media/Mud+Alkalinity/1_8cc15mab/103763052" },
                            { "id": "v_vid_8", "name": "pH", "url": "https://www.halliburton.tv/media/pH/1_g4o4t54r/103763052" },
                            { "id": "v_vid_9", "name": "Total Hardness", "url": "https://www.halliburton.tv/media/Total+Hardness/1_knfwxg7n/103763052" },
                            { "id": "v_vid_10", "name": "Filtrate Alkalinity", "url": "https://www.halliburton.tv/media/Filtrate+Alkalinity/1_am8icj5x/103763052" },
                            { "id": "v_vid_11", "name": "Chloride Test", "url": "https://www.halliburton.tv/media/Chloride+Test/1_75qph17x/103763052" },
                            { "id": "v_vid_12", "name": "Calcium Hardness", "url": "https://www.halliburton.tv/media/Calcium+Hardness/1_iht33xji/103763052" },
                            { "id": "v_vid_13", "name": "Funnel Viscosity", "url": "https://www.halliburton.tv/media/Funnel_Viscosity/1_qu4n8k5b/103763052" },
                            { "id": "v_vid_14", "name": "Pressurized Mud Balance", "url": "https://www.halliburton.tv/media/Pressurized+Mud+Balance/1_5993wdva/103763052" },
                            { "id": "v_vid_15", "name": "Drilling Fluid Density (Mud Balance)", "url": "https://www.halliburton.tv/media/Drilling+Fluid+Density+%28Mud+Balance%29/1_ui8vbq0r/103763052" },
                            { "id": "v_vid_16", "name": "Electrical Stability", "url": "https://www.halliburton.tv/media/Electrical+Stability/1_dfy15389/103763052" },
                            { "id": "v_vid_17", "name": "Rheology", "url": "https://www.halliburton.tv/media/Rheology/1_lh04jaa6/103763052" },
                            { "id": "v_vid_18", "name": "LTLP Test", "url": "https://www.halliburton.tv/media/LTLP+Test/1_mznr88hp/103763052" },
                            { "id": "v_vid_19", "name": "Sand Content", "url": "https://www.halliburton.tv/media/Sand+Content/1_jqui02vp/103763052" },
                            { "id": "v_vid_20", "name": "Methylene Blue Capacity Test", "url": "https://www.halliburton.tv/media/Methylene+Blue+Capacity+Test/1_v7zqnndd/103763052" },
                            { "id": "v_vid_21", "name": "Running the Retort", "url": "https://www.halliburton.tv/media/Running+the+Retort/1_x4x1vajc/103763052" }
                        ]
                    }
                ]
            },
            {
                "id": "sec_qa",
                "name": "Calidad & Documentación Técnica",
                "icon": "package",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_qa_kpi",
                        "name": "Encuesta Cliente y KPI",
                        "links": [
                            {
                                "id": "l_qa_kpi_1",
                                "name": "Encuesta de Satisfacción Cliente (ENG)",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0047106&sys_kb_id=34da0e982b397e1044fffa08b891bf73&spa=1"
                            },
                            {
                                "id": "l_qa_kpi_2",
                                "name": "Encuesta de Satisfacción Cliente (ESP)",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=664ad7c18738295096137519dabb354f&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=d770e8f22ba3269432d6fd695e91bf9e"
                            },
                            {
                                "id": "l_qa_kpi_3",
                                "name": "KPI - Fluids Baroid",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0049248&sys_kb_id=2eaf8d532b7fae1099bafa85d391bf17&spa=1"
                            }
                        ]
                    },
                    {
                        "id": "sub_qa_1",
                        "name": "Sistemas Gestión Química",
                        "links": [
                            {
                                "id": "l_qa_1",
                                "name": "QC DOC - Lotes y Vencimientos",
                                "url": "https://qcdoc.corp.halliburton.com/COQ/ManageCOQ.aspx",
                                "lastUsed": 1768760503484
                            },
                            {
                                "id": "l_qa_2",
                                "name": "SDS - BARATAG - Carteles",
                                "url": "https://halliburton-sds.thewercs.com/Internal",
                                "lastUsed": 1768760505180
                            }
                        ]
                    },
                    {
                        "id": "sub_qa_checklist",
                        "name": "Checklists",
                        "links": [
                            {
                                "id": "l_qa_ch_1",
                                "name": "Estación Lavaojos",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=d36c21cb1b364a9017bacb7f034bcb44&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=ce04f74a2b2e72d87b31f161fe91bf70"
                            },
                            {
                                "id": "l_qa_ch_2",
                                "name": "Bandejas - Contenedores Secundarios",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=782c99c347d1ee10d49f5131e36d43c9&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=50283bc22baab2d87b31f161fe91bf25"
                            },
                            {
                                "id": "l_qa_ch_3",
                                "name": "Kit De Primeros Auxilios",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=17d1a7532b4f6a107b31f161fe91bfdb&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=5328f7862baab2d87b31f161fe91bf0a"
                            },
                            {
                                "id": "l_qa_ch_4",
                                "name": "Inspección de Extintores",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=cd7ed4622bbd2a501581fdf2fe91bf9e&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=47587b422beab2d87b31f161fe91bf52"
                            },
                            {
                                "id": "l_qa_ch_5",
                                "name": "Inspección de Estaciones Lavaojos",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=d36c21cb1b364a9017bacb7f034bcb44&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=31687fc22beab2d87b31f161fe91bfd2"
                            },
                            {
                                "id": "l_qa_ch_6",
                                "name": "Inspeccion del Kit Antiderrames",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=451c39781b63c2d407872fc42a4bcb92&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=bf68ff462beab2d87b31f161fe91bf99"
                            },
                            {
                                "id": "v_trailer",
                                "name": "Inspección de Trailer",
                                "url": "https://nam10.safelinks.protection.outlook.com/?url=https%3A%2F%2Fhalliburton.service-now.com%2Fhms%3Fsys_kb_id%3D45b045824738d61080e583f8536d4360%26id%3Dkb_article_view%26sysparm_rank%3D1%26sysparm_tsqueryId%3Da7fcb8d92b033a101581fdf2fe91bf9d&data=05%7C02%7CXavierCustodio.Rinaudo2%40halliburton.com%7C8cd1d1639efc442b2c4108de6a844c17%7Cb7be76866f974db79081a23cf09a96b5%7C0%7C0%7C639065313781407699%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=SjF0cGF%2FdSXMSEIkQ8CA9aV6d0MeUvVAk4r%2BXoa0l54%3D&reserved=0"
                            }
                        ]
                    },
                    {
                        "id": "sub_qa_handover",
                        "name": "Cambio de Guardia",
                        "links": [
                            {
                                "id": "l_qa_ho_1",
                                "name": "Cambio de Guardia Diario - Handover",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=aaa75fa2470fde50d49f5131e36d43dc&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=df484cde2bae76d87b31f161fe91bf17"
                            },
                            {
                                "id": "l_qa_ho_2",
                                "name": "Cambio de Guardia Diagrama",
                                "url": "https://halliburton.service-now.com/hms?sys_kb_id=8a2f9a0887ea525896137519dabb35e0&id=kb_article_view&sysparm_rank=1&sysparm_tsqueryId=b738881e2bae76d87b31f161fe91bf7f"
                            }
                        ]
                    }
                ]
            },
            {
                "id": "sec_proc",
                "name": "Procesos & Control de Servicio",
                "icon": "settings",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_proc_1",
                        "name": "SharePoint",
                        "links": [
                            {
                                "id": "l_pr_1",
                                "name": "Baroid People Process: SharePoint",
                                "url": "https://halliburton.sharepoint.com/sites/BaroidTraining/SitePages/Baroid-People-Process.aspx"
                            }
                        ]
                    },
                    {
                        "id": "sub_proc_2",
                        "name": "Procesos empresa",
                        "links": [
                            {
                                "id": "l_pr_3",
                                "name": "Control Points",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0021741",
                                "lastUsed": 1768762697145,
                                "isFavorite": false
                            },
                            {
                                "id": "l_pr_4",
                                "name": "Critical Focus Area",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0036971",
                                "lastUsed": 1768762548924
                            },
                            {
                                "id": "l_pr_5",
                                "name": "Paso 400",
                                "url": "https://halliburton.service-now.com/hms?id=kb_article_view&sysparm_article=KB0047800",
                                "lastUsed": 1768760515596
                            },
                            {
                                "id": "l_pr_resp",
                                "name": "Responsabilidades del Ing.",
                                "url": "https://nam10.safelinks.protection.outlook.com/?url=https%3A%2F%2Fhalliburton.service-now.com%2Fhms%3Fsys_kb_id%3Da67b83ca2bebe2d08f5bf4e2fe91bf86%26id%3Dkb_article_view%26sysparm_rank%3D1%26sysparm_tsqueryId%3D950ed0132b36b2107b31f161fe91bf02&data=05%7C02%7CXavierCustodio.Rinaudo2%40halliburton.com%7C05424c923beb4e7274fd08de6a2f0a62%7Cb7be76866f974db79081a23cf09a96b5%7C0%7C0%7C639064947735198833%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=w58jIWdsDUwIFdbewiigT6Mrnehnc3CFkLsAWdf9gLI%3D&reserved=0"
                            }
                        ]
                    }
                ]
            },
            {
                "id": "sec_corp",
                "name": "Corporativo & Marketing",
                "icon": "briefcase",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_corp_1",
                        "name": "Recursos Branding",
                        "links": [
                            {
                                "id": "l_cp_1",
                                "name": "Recursos branding",
                                "url": "https://brandfolder.com/hal-corporate/corporate-marketing-internal?o=OR&q=templates"
                            },
                            {
                                "id": "l_cp_2",
                                "name": "Plantilla Powerpoint",
                                "url": "https://halliburton.sharepoint.com/sites/BrandCenter"
                            }
                        ]
                    }
                ]
            },
            {
                "id": "sec_pdf",
                "name": "Documentos & Guías PDF",
                "icon": "file-text",
                "color": "#CC0000",
                "subsectors": [
                    {
                        "id": "sub_pdf_user",
                        "name": "Mis Archivos PDF",
                        "links": []
                    }
                ]
            }
        ];

        const FloatingNotes = ({ notes, setNotes, showNotes, setShowNotes }) => (
            <div className="fixed bottom-8 right-8 z-[100] flex flex-col items-end gap-4">
                <div className={`notes-window glass-morphism w-80 h-96 rounded-[2.5rem] p-8 shadow-2xl flex flex-col ${showNotes ? 'visible' : 'hidden'}`}>
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-halliburton-red rounded-lg flex items-center justify-center shadow-lg">
                                <Icon name="sticky-note" size={16} className="text-white" />
                            </div>
                            <span className="text-xs font-black uppercase tracking-widest text-zinc-800 dark:text-white">Notas Rápidas</span>
                        </div>
                        <button onClick={() => setShowNotes(false)} className="text-zinc-400 hover:text-halliburton-red transition-colors">
                            <Icon name="x" size={20} />
                        </button>
                    </div>
                    <textarea
                        value={notes}
                        onChange={e => setNotes(e.target.value)}
                        placeholder="Escribe algo aquí..."
                        className="flex-1 w-full bg-transparent border-none resize-none focus:outline-none text-sm leading-relaxed custom-scrollbar notepad-area dark:text-zinc-200"
                    ></textarea>
                    <div className="mt-4 pt-4 border-t border-zinc-200/50 dark:border-zinc-700/50 flex justify-between items-center text-[10px] text-zinc-400 font-bold uppercase tracking-widest">
                        <span>Autoguardado</span>
                        <Icon name="save" size={12} />
                    </div>
                </div>

                <button
                    onClick={() => setShowNotes(!showNotes)}
                    className="notes-bubble w-16 h-16 bg-halliburton-red rounded-full flex items-center justify-center text-white shadow-2xl relative"
                >
                    <Icon name={showNotes ? "chevron-down" : "pencil"} size={28} />
                    {!showNotes && notes.length > 0 && (
                        <div className="absolute -top-1 -right-1 w-5 h-5 bg-zinc-800 rounded-full border-2 border-white dark:border-zinc-900 flex items-center justify-center text-[8px] font-black">
                            <Icon name="check" size={8} />
                        </div>
                    )}
                </button>
            </div>
        );

        const App = () => {
            const [sectors, setSectors] = useState(() => {
                const saved = localStorage.getItem('baroid_hub_data_v5');
                return saved ? JSON.parse(saved) : INITIAL_DATA_REFINED;
            });
            const [activeSector, setActiveSector] = useState(sectors[0]?.id || 'sec_hr');
            const [searchQuery, setSearchQuery] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [showModal, setShowModal] = useState(null);
            const [modalData, setModalData] = useState({});
            const [showNotes, setShowNotes] = useState(false);
            const [cardSize, setCardSize] = useState(() => localStorage.getItem('baroid_card_size') || 'large');
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('baroid_dark_mode') === 'true');
            const [notes, setNotes] = useState(() => localStorage.getItem('baroid_notes') || '');
            const searchInputRef = useRef(null);
            const fileInputRef = useRef(null);

            const resetToDefaults = () => {
                if (confirm('Se borraran todos los cambios personalizados de la app. ¿Desea continuar?')) {
                    const keysToRemove = [
                        'baroid_piletas_v8',
                        'baroid_fluid_systems_v4',
                        'baroid_calc_tabs_v3',
                        'baroid_treatment_config',
                        'baroid_hub_data_v5',
                        'baroid_calc_tabs_v2',
                        'baroid_card_size',
                        'baroid_dark_mode',
                        'baroid_notes'
                    ];
                    keysToRemove.forEach(k => localStorage.removeItem(k));
                    window.location.reload();
                }
            };

            const [stableLastUsed, setStableLastUsed] = useState({});

            useEffect(() => {
                const news = {};
                sectors.forEach(s => (s.subsectors || []).forEach(sub => (sub.links || []).forEach(l => {
                    news[l.id] = l.lastUsed || 0;
                })));
                setStableLastUsed(news);
            }, [activeSector, searchQuery]); // Quitamos 'sectors' de aquí para evitar bucles

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        searchInputRef.current?.focus();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('baroid_dark_mode', darkMode);
            }, [darkMode]);

            useEffect(() => {
                localStorage.setItem('baroid_card_size', cardSize);
            }, [cardSize]);

            useEffect(() => {
                localStorage.setItem('baroid_notes', notes);
            }, [notes]);

            useEffect(() => {
                localStorage.setItem('baroid_hub_data_v5', JSON.stringify(sectors));
            }, [sectors]);

            const exportData = () => {
                const dataStr = JSON.stringify(sectors, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `baroid_hub_backup_${new Date().toISOString().split('T')[0]}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedSectors = JSON.parse(event.target.result);
                        if (Array.isArray(importedSectors)) {
                            setSectors(importedSectors);
                            alert('Datos importados con éxito.');
                        } else {
                            alert('Formato de archivo no válido.');
                        }
                    } catch (err) {
                        alert('Error al leer el archivo.');
                    }
                };
                reader.readAsText(file);
            };

            const toggleFavorite = (lid) => {
                setSectors(prev => prev.map(s => ({
                    ...s,
                    subsectors: s.subsectors.map(sub => ({
                        ...sub,
                        links: sub.links.map(l => l.id === lid ? { ...l, isFavorite: !l.isFavorite } : l)
                    }))
                })));
            };

            const trackLinkClick = (lid) => {
                setSectors(prev => prev.map(s => ({
                    ...s,
                    subsectors: s.subsectors.map(sub => ({
                        ...sub,
                        links: sub.links.map(l => l.id === lid ? { ...l, lastUsed: Date.now() } : l)
                    }))
                })));
            };

            const updateItem = (target, id, newName, newUrl = null, newIcon = null) => {
                setSectors(prev => prev.map(s => {
                    if (target === 'sector' && s.id === id) return { ...s, name: newName, icon: newIcon || s.icon };
                    return {
                        ...s,
                        subsectors: s.subsectors.map(sub => {
                            if (target === 'subsector' && sub.id === id) return { ...sub, name: newName };
                            return {
                                ...sub,
                                links: sub.links.map(l => {
                                    if (target === 'link' && l.id === id) return { ...l, name: newName, url: newUrl || l.url };
                                    return l;
                                })
                            };
                        })
                    };
                }));
                setShowModal(null);
            };

            const addSector = (name, icon) => {
                setSectors(prev => [...prev, { id: 'sec_' + Date.now(), name, icon, color: '#CC0000', subsectors: [] }]);
                setShowModal(null);
            };

            const addSubsector = (sid, name) => {
                setSectors(prev => prev.map(s => s.id === sid ? { ...s, subsectors: [...s.subsectors, { id: 'sub_' + Date.now(), name, links: [] }] } : s));
                setShowModal(null);
            };

            const addLink = (sid, subsid, name, url) => {
                setSectors(prev => prev.map(s => s.id === sid ? {
                    ...s, subsectors: s.subsectors.map(sub => sub.id === subsid ? { ...sub, links: [...sub.links, { id: 'l_' + Date.now(), name, url, isFavorite: false }] } : sub)
                } : s));
                setShowModal(null);
            };

            // Bridge for PDF uploads from MainContent
            window.baroidAddPdf = addLink;

            const deleteItem = (type, sid, subsid = null, lid = null) => {
                if (!confirm(`¿Eliminar ${type}?`)) return;
                if (type === 'sector') setSectors(prev => prev.filter(s => s.id !== sid));
                if (type === 'subsector') setSectors(prev => prev.map(s => s.id === sid ? { ...s, subsectors: s.subsectors.filter(sub => sub.id !== subsid) } : s));
                if (type === 'link') setSectors(prev => prev.map(s => s.id === sid ? { ...s, subsectors: s.subsectors.map(sub => sub.id === subsid ? { ...sub, links: sub.links.filter(l => l.id !== lid) } : sub) } : s));
            };

            const favoritesList = useMemo(() => {
                const favs = [];
                sectors.forEach(s => {
                    (s.subsectors || []).forEach(sub => {
                        (sub.links || []).forEach(l => {
                            if (l.isFavorite) {
                                favs.push({ ...l, sid: s.id, subsid: sub.id });
                            }
                        });
                    });
                });
                return favs;
            }, [sectors]);

            const displaySectors = useMemo(() => {
                let data = [];

                if (activeSector === 'favorites') {
                    data = [{
                        id: 'fav',
                        name: 'Mis Favoritos',
                        icon: 'heart',
                        color: '#CC0000',
                        subsectors: [{ id: 'fs1', name: 'Documentos Destacados', links: favoritesList }]
                    }];
                } else if (activeSector === 'calculator' || activeSector === 'inventory') {
                    data = [];
                } else {
                    data = sectors.filter(s => s.id === activeSector);
                }

                if (searchQuery && searchQuery.trim() !== '') {
                    const q = searchQuery.toLowerCase();
                    // Si buscamos y estamos en favoritos, buscamos solo en favoritos. Si no, en todo.
                    const source = activeSector === 'favorites' ? data : sectors;
                    data = source.map(s => ({
                        ...s,
                        subsectors: (s.subsectors || []).map(sub => ({
                            ...sub,
                            links: (sub.links || []).filter(l =>
                                l.name.toLowerCase().includes(q) ||
                                sub.name.toLowerCase().includes(q)
                            )
                        })).filter(sub => sub.links.length > 0)
                    })).filter(s => s.subsectors.length > 0);
                }

                return data.map(s => ({
                    ...s,
                    subsectors: (s.subsectors || []).map(sub => ({
                        ...sub,
                        links: [...(sub.links || [])].sort((a, b) => (stableLastUsed[b.id] || 0) - (stableLastUsed[a.id] || 0))
                    }))
                }));
            }, [sectors, activeSector, searchQuery, stableLastUsed, favoritesList]);

            return (
                <div className="bg-[var(--h-bg)] min-h-screen transition-colors duration-300 flex justify-center">
                    <div className="flex w-full max-w-[1600px] relative shadow-2xl">
                        <Sidebar
                            sectors={sectors}
                            setActiveSector={setActiveSector}
                            activeSector={activeSector}
                            searchQuery={searchQuery}
                            setSearchQuery={setSearchQuery}
                            isEditing={isEditing}
                            setIsEditing={setIsEditing}
                            darkMode={darkMode}
                            setDarkMode={setDarkMode}
                            resetToDefaults={resetToDefaults}
                            exportData={exportData}
                            importData={importData}
                            fileInputRef={fileInputRef}
                            searchInputRef={searchInputRef}
                            notes={notes}
                            setNotes={setNotes}
                            favorites={favoritesList}
                            deleteItem={deleteItem}
                            setShowModal={setShowModal}
                            setModalData={setModalData}
                            cardSize={cardSize}
                            setCardSize={setCardSize}
                        />
                        <MainContent
                            displaySectors={displaySectors}
                            activeSector={activeSector}
                            searchQuery={searchQuery}
                            sectors={sectors}
                            isEditing={isEditing}
                            setShowModal={setShowModal}
                            setModalData={setModalData}
                            deleteItem={deleteItem}
                            trackLinkClick={trackLinkClick}
                            toggleFavorite={toggleFavorite}
                            cardSize={cardSize}
                            setCardSize={setCardSize}
                            darkMode={darkMode}
                            setDarkMode={setDarkMode}
                        />
                        <Modal
                            showModal={showModal}
                            setShowModal={setShowModal}
                            modalData={modalData}
                            addSector={addSector}
                            addSubsector={addSubsector}
                            addLink={addLink}
                            updateItem={updateItem}
                        />
                        <FloatingNotes
                            notes={notes}
                            setNotes={setNotes}
                            showNotes={showNotes}
                            setShowNotes={setShowNotes}
                        />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Register the Service Worker to enable PWA installation and offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado', reg))
                    .catch(err => console.log('Error al registrar SW', err));
            });
        }
    </script>
</body>

</html>